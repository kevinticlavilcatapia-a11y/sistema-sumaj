<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA SUMAJ - v28.0 (MAPA FIX)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --disponible:#2ecc71; 
            --ocupado:#e74c3c;     
            --salida: #fd7e14;     
            --historial: #6c757d;  
            --sucia: #f1c40f; 
            --limpieza: #3498db; 
            --dark:#1a2a3a; 
            --accent:#3498db; 
        }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: var(--dark) !important; border-bottom: 3px solid var(--accent); }
        .nav-link.active { color: var(--accent) !important; border-bottom: 3px solid var(--accent) !important; }
        
        /* --- MEJORA VISUAL MAPA --- */
        .hab-card { 
            border-radius: 12px; 
            border: 1px solid #e0e0e0; 
            background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border-left: 10px solid transparent; 
            position: relative; 
            overflow: hidden; 
            height: 100%; 
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .hab-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.1); 
            filter: brightness(0.98);
        }
        .hab-card .card-body { padding: 15px; }
        
        /* Estados */
        .status-disponible { border-left-color: var(--disponible); } 
        .status-ocupado { border-left-color: var(--ocupado); background: #fff5f5; } 
        .status-salida { border-left-color: var(--salida); background: #fffbf2; }
        .status-sucia { border-left-color: var(--sucia); background: #fffff0; } 
        .status-limpieza { border-left-color: var(--limpieza); background: #f0f8ff; }
        
        .piso-header { background: #cbd5e0; color: #2d3748; padding: 8px 15px; border-radius: 8px; margin-top: 30px; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; }
        
        /* Calendario */
        .cal-wrapper { overflow-x: auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table-calendar { font-size: 0.75rem; border-collapse: separate; border-spacing: 1px; width: 100%; min-width: 900px; }
        .table-calendar th { text-align: center; background: #343a40; color: white; padding: 8px; position: sticky; top: 0; z-index: 20; }
        .cal-room-col { background: #212529; color: white; position: sticky; left: 0; z-index: 30; font-weight: bold; width: 60px; text-align: center; }
        .cal-cell { height: 40px; border: 1px solid #dee2e6; vertical-align: middle; text-align: center; min-width: 40px; padding: 0; position: relative; background-color: #fff; cursor: pointer; transition: 0.2s; }
        .cal-cell:hover { border: 2px solid #333; z-index: 10; }
        .cal-today-col { border-bottom: 3px solid #ffc107 !important; background-color: #fffbe6; }

        /* UI General */
        .op-card { font-size: 0.9rem; margin-bottom: 8px; border-left: 5px solid #ccc; background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; } 
        .op-in { border-left-color: #2ecc71; } .op-out { border-left-color: #e74c3c; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #333; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 3rem; border-radius: 8px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); text-align: center; }
        .btn-login-custom { background-color: #6d4c41; border: none; color: white; transition: 0.3s; } 
        .btn-login-custom:hover { background-color: #5d4037; color: white; }
        .detail-header { background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; }
        .total-box { background: linear-gradient(to right, #f8f9fa, #fff); border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; }
        .debt-high { color: #dc3545; font-size: 1.4rem; font-weight: 800; } 
        .debt-ok { color: #198754; font-size: 1.4rem; font-weight: 800; }
        #cloudLoader { position: fixed; top: 10px; right: 10px; z-index: 10000; background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: none; }
        .found-client { background-color: #d4edda !important; transition: background-color 0.5s; }
    </style>
</head>
<body>

<div id="cloudLoader"><i class="fas fa-sync fa-spin me-2"></i>Sincronizando...</div>

<div id="loginOverlay">
    <div class="login-card">
        <h2 class="fw-bold mb-4" style="color: #3e2723; font-size: 2rem; letter-spacing: 1px;">SUMAJ LODGE</h2>
        <div class="mb-3 text-start"><label class="form-label fw-bold text-secondary small">USUARIO</label><input type="text" id="loginUser" class="form-control form-control-lg bg-white border-secondary-subtle"></div>
        <div class="mb-4 text-start"><label class="form-label fw-bold text-secondary small">CONTRASE√ëA</label><input type="password" id="loginPass" class="form-control form-control-lg bg-white border-secondary-subtle"></div>
        <button class="btn btn-login-custom w-100 fw-bold py-3 fs-6 shadow-sm" onclick="window.funcs.login()">INGRESAR</button>
    </div>
</div>

<div id="appInterface" style="display:none;">
    <nav class="navbar navbar-expand shadow mb-4">
        <div class="container-fluid px-4">
            <span class="navbar-brand fw-bold text-white"><i class="fas fa-hotel me-2"></i>SUMAJ LAGOON LODGE <span class="badge bg-success ms-2" style="font-size:0.6rem">ONLINE</span></span>
            <div class="d-flex align-items-center gap-3">
                <div class="text-white small text-end"><div id="userDisplay" class="fw-bold text-warning"></div><div id="reloj" class="fw-light"></div></div>
                <button class="btn btn-sm btn-outline-light" onclick="window.funcs.logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <ul class="nav nav-tabs mb-4 border-0" id="mainTabs">
            <li class="nav-item" id="nav-mapa"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-mapa">üó∫Ô∏è MAPA</button></li>
            <li class="nav-item" id="nav-limpieza"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-limpieza" onclick="window.funcs.renderLimpieza()">üßπ LIMPIEZA</button></li>
            <li class="nav-item" id="nav-calendario"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-calendario" onclick="window.funcs.renderCal()">üìÖ CALENDARIO</button></li>
            <li class="nav-item" id="nav-operaciones"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-operaciones" onclick="window.funcs.actualizarOperaciones()">üìã OPERACIONES</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-caja" onclick="window.funcs.renderCaja()">üí∞ CAJA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inventario">üì¶ ALMAC√âN</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-usuarios" onclick="window.funcs.renderUsuarios()">üë• USUARIOS</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-auditoria" onclick="window.funcs.renderLogs()">üëÅÔ∏è AUDITOR√çA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config" onclick="window.funcs.renderConfigHabs()">‚öôÔ∏è CONFIGURACI√ìN</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-mapa">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm">
                        <div class="d-flex align-items-center gap-3">
                            <span class="small fw-bold text-muted">VISTA: HOY</span>
                            <div class="d-flex gap-2 small">
                                <span class="badge bg-success">Libre</span>
                                <span class="badge bg-danger">Ocupado</span>
                                <span class="badge text-dark" style="background-color: var(--salida);">Salida Hoy</span>
                                <span class="badge bg-warning text-dark">Sucia</span>
                                <span class="badge bg-primary">Limpieza</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-primary fw-bold shadow-sm" onclick="window.funcs.abrirModalNuevaReserva()">‚ûï NUEVA RESERVA</button>
                            <input type="date" id="filtroFecha" class="form-control w-auto shadow-sm" onchange="window.funcs.actualizarPantalla()">
                        </div>
                    </div>
                    <div id="gridHabitaciones" class="row g-3"></div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="tab-limpieza"><div class="card p-4 border-0 shadow-sm"><h5 class="fw-bold mb-4"><i class="fas fa-broom"></i> Gesti√≥n de Limpieza</h5><div class="row"><div class="col-md-6 border-end"><h6 class="text-danger fw-bold border-bottom pb-2">SUCIAS / EN PROCESO</h6><div id="listSucias" class="mt-3"></div></div><div class="col-md-6"><h6 class="text-success fw-bold border-bottom pb-2">LISTAS</h6><div id="listLimpias" class="mt-3"></div></div></div></div></div>
            <div class="tab-pane fade" id="tab-calendario"><div class="card border-0 shadow-sm p-3"><div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-3 bg-light p-2 rounded"><div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-outline-dark" onclick="window.funcs.navMes(-1)"><i class="fas fa-chevron-left"></i></button><h6 class="m-0 fw-bold text-uppercase" id="calMesTitulo" style="min-width: 150px; text-align:center;"></h6><button class="btn btn-sm btn-outline-dark" onclick="window.funcs.navMes(1)"><i class="fas fa-chevron-right"></i></button></div><div class="d-flex align-items-center gap-3"><div class="small fw-bold"><span style="display:inline-block;width:12px;height:12px;background:var(--ocupado);margin-right:4px;"></span>Ocupado<span style="display:inline-block;width:12px;height:12px;background:var(--salida);margin-left:8px;margin-right:4px;"></span>Salida Hoy</div><div class="btn-group"><button class="btn btn-sm btn-outline-primary fw-bold shadow-sm" onclick="window.funcs.exportarCalImg()"><i class="fas fa-image me-1"></i> IMG</button><button class="btn btn-sm btn-outline-danger fw-bold shadow-sm" onclick="window.funcs.exportarCalPDF()"><i class="fas fa-file-pdf me-1"></i> PDF</button></div></div></div><div id="calContainer" class="cal-wrapper"><table class="table-calendar" id="tablaCal"></table></div></div></div>
            <div class="tab-pane fade" id="tab-operaciones"><div class="card p-4 border-0 shadow-sm"><div class="d-flex justify-content-between mb-4"><h5 class="fw-bold">Reporte Operativo</h5><div class="d-flex gap-2"><input type="date" id="fechaOp" class="form-control w-auto" onchange="window.funcs.actualizarOperaciones()"><button class="btn btn-outline-secondary btn-sm" onclick="window.funcs.imprimirOp()">Imprimir</button></div></div><div id="opArea" class="row g-4"><div class="col-md-6 border-end"><h6>LLEGADAS</h6><div id="listIn"></div></div><div class="col-md-6"><h6>SALIDAS</h6><div id="listOut"></div></div></div></div></div>
            <div class="tab-pane fade" id="tab-caja"><div class="row g-4"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm mb-3"><h6 class="fw-bold mb-3 text-primary">Caja Chica</h6><select id="cajaTipo" class="form-select mb-2"><option value="egreso">üî¥ EGRESO</option><option value="ingreso">üü¢ INGRESO</option></select><select id="cajaCat" class="form-select mb-2"><option>Compras</option><option>Servicios</option><option>Otros</option></select><input type="text" id="cajaDesc" class="form-control mb-2" placeholder="Descripci√≥n"><input type="number" id="cajaMonto" class="form-control mb-2" placeholder="Monto"><button class="btn btn-dark w-100" onclick="window.funcs.guardarMovimientoCaja()">REGISTRAR</button></div><div class="card bg-warning bg-opacity-10 p-3 text-center"><h6 class="fw-bold">SALDO</h6><h2 class="fw-bold text-warning" id="cajaSaldo">S/ 0.00</h2></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-sm" id="tablaCaja"><thead class="table-light"><tr><th>Fecha</th><th>Tipo</th><th>Desc</th><th>Monto</th><th></th></tr></thead><tbody id="bodyCaja"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-inventario"><div class="row g-4"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm"><h6>Nuevo Item</h6><select id="invTipo" class="form-select mb-2" onchange="window.funcs.toggleStockInput()"><option value="producto">Producto</option><option value="servicio">Servicio</option></select><input type="text" id="invNombre" class="form-control mb-2" placeholder="Nombre"><input type="number" id="invPrecio" class="form-control mb-2" placeholder="Precio"><div id="divStockInput"><input type="number" id="invStock" class="form-control mb-2" placeholder="Stock"></div><button class="btn btn-success w-100" onclick="window.funcs.agregarProducto()">GUARDAR</button></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-sm"><thead class="table-light"><tr><th>Item</th><th>Tipo</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead><tbody id="tablaInventario"></tbody></table></div></div></div></div>
            
            <div class="tab-pane fade" id="tab-usuarios"><div class="row"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">Nuevo Usuario</h6><input type="hidden" id="editUserIndex" value="-1"><label class="small">Usuario</label><input type="text" id="newUserName" class="form-control mb-2"><label class="small">Contrase√±a</label><input type="text" id="newUserPass" class="form-control mb-2"><label class="small fw-bold mt-2">Rol:</label><select id="newUserRole" class="form-select mb-3"><option value="recepcion">üõéÔ∏è Recepcionista</option><option value="admin">üëë Administrador</option><option value="limpieza">üßπ Limpieza</option></select><div class="d-flex gap-2 mt-3"><button class="btn btn-primary w-100" onclick="window.funcs.guardarUsuario()">Guardar</button><button class="btn btn-outline-secondary" onclick="window.funcs.limpiarFormUsuario()">Limpiar</button></div></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-hover table-sm small"><thead class="table-light"><tr><th>User</th><th>Pass</th><th>Rol</th><th></th></tr></thead><tbody id="tablaUsuarios"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-auditoria"><div class="card p-4 border-0 shadow-sm"><div class="d-flex justify-content-between mb-3"><h6 class="fw-bold">Logs</h6><button class="btn btn-sm btn-secondary" onclick="window.funcs.imprimirLogs()">Imprimir</button></div><div class="table-responsive" id="printLogsArea"><table class="table table-striped table-sm log-table"><thead class="table-dark"><tr><th>Fecha</th><th>User</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody id="tablaLogs"></tbody></table></div></div></div>
            <div class="tab-pane fade" id="tab-config"><div class="alert alert-info"><b>Modo Nube Activado:</b> Los datos se guardan autom√°ticamente en Google Firebase.</div><div class="row g-4"><div class="col-md-5"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">üõ†Ô∏è Copias de Seguridad Local</h6><button class="btn btn-primary w-100 mb-2" onclick="window.funcs.descargarBackup()">‚¨áÔ∏è DESCARGAR DATA</button></div></div><div class="col-md-7"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">üè® Gesti√≥n de Habitaciones</h6><div class="input-group mb-3"><input type="number" id="confNum" class="form-control" placeholder="N¬∞ Hab"><input type="text" id="confPiso" class="form-control" placeholder="Piso/Sec"><button class="btn btn-dark" onclick="window.funcs.agregarHabitacion()">‚ûï Agregar</button></div><div class="table-responsive" style="max-height: 400px; overflow-y:auto;"><table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th>Hab</th><th>Piso</th><th>Acci√≥n</th></tr></thead><tbody id="bodyConfigHabs"></tbody></table></div></div></div></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoIngreso" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
            <div class="modal-header bg-primary text-white p-4" style="background: linear-gradient(135deg, #1a2a3a 0%, #2980b9 100%);"><div><h5 class="fw-bold m-0"><i class="fas fa-concierge-bell me-2"></i>Nuevo Check-In</h5><small class="text-white-50">Registre los datos de ingreso</small></div><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body p-0"><div class="row g-0"><div class="col-md-7 p-4"><h6 class="text-primary fw-bold mb-3 text-uppercase small ls-1"><i class="fas fa-user-circle me-1"></i> Datos del Hu√©sped</h6><div class="row g-2 mb-4"><div class="col-4"><label class="form-label small text-muted fw-bold">DNI / Doc</label><input type="text" id="dni" class="form-control form-control-sm bg-light" placeholder="12345678" onkeyup="window.funcs.buscarCliente(this.value)"></div><div class="col-8"><label class="form-label small text-muted fw-bold">Nombre Completo</label><input type="text" id="cliente" class="form-control form-control-sm fw-bold" placeholder="Nombre del Cliente"></div><div class="col-6"><label class="form-label small text-muted fw-bold">Celular</label><div class="input-group input-group-sm"><span class="input-group-text bg-white"><i class="fas fa-phone small text-muted"></i></span><input type="text" id="c_celular" class="form-control" placeholder="999..."></div></div><div class="col-6"><label class="form-label small text-muted fw-bold">Pax</label><input type="number" id="numPersonas" class="form-control form-control-sm" value="1" min="1"></div></div><h6 class="text-primary fw-bold mb-3 text-uppercase small ls-1 border-top pt-3"><i class="fas fa-bed me-1"></i> Estancia</h6><div class="row g-2"><div class="col-6"><label class="form-label small text-muted fw-bold">Habitaci√≥n</label><select id="habSelect" class="form-select form-select-sm fw-bold border-primary" onchange="window.funcs.checkTipoHab('mapa')"></select></div><div class="col-6"><label class="form-label small text-muted fw-bold">Tipo</label><select id="tipoHab" class="form-select form-select-sm bg-light"></select></div><div class="col-6"><label class="form-label small text-muted fw-bold">Llegada</label><input type="date" id="checkin" class="form-control form-control-sm"></div><div class="col-6"><label class="form-label small text-muted fw-bold">Salida</label><input type="date" id="checkout" class="form-control form-control-sm"></div></div></div><div class="col-md-5 bg-light p-4 border-start d-flex flex-column justify-content-between"><div><h6 class="text-success fw-bold mb-3 text-uppercase small ls-1"><i class="fas fa-file-invoice-dollar me-1"></i> Facturaci√≥n</h6><div class="card border-0 shadow-sm mb-3"><div class="card-body p-3"><label class="small fw-bold mb-1 text-muted">Monto Total</label><div class="input-group mb-3"><span class="input-group-text bg-white border-end-0 fw-bold text-success">S/</span><input type="number" id="total" class="form-control border-start-0 fs-4 fw-bold text-dark" value="0"></div><div class="mb-3"><label class="small text-muted fw-bold">Estado del Pago</label><select id="pagoEstado" class="form-select form-select-sm fw-bold" onchange="window.funcs.toggleAdelanto()"><option value="Falta Pagar" class="text-danger">üî¥ Falta Pagar</option><option value="Pagado" class="text-success">üü¢ Pagado Completo</option><option value="Adelanto" class="text-warning">üü† Dejar Adelanto</option></select></div><div id="divAdelanto" style="display:none;" class="mb-3 p-2 bg-warning bg-opacity-10 rounded border border-warning"><label class="small fw-bold text-dark">Monto Adelanto</label><div class="input-group input-group-sm"><span class="input-group-text bg-white text-dark">S/</span><input type="number" id="adelanto" class="form-control fw-bold" value="0"></div></div><div><label class="small text-muted fw-bold">Medio de Pago</label><select id="medioPago" class="form-select form-select-sm"><option>Efectivo</option><option>Yape</option><option>Plin</option><option>Tarjeta</option><option>Transferencia</option></select></div></div></div></div><button class="btn btn-primary w-100 py-3 fw-bold shadow hover-effect" onclick="window.funcs.guardarReserva()"><i class="fas fa-check-circle me-2"></i> CONFIRMAR RESERVA</button></div></div></div></div></div>
<div class="modal fade" id="modalH" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg"><div id="mh" class="modal-header detail-header"><h5 id="mt" class="fw-bold m-0 text-dark"><i class="fas fa-door-open me-2 text-primary"></i>Detalle Habitaci√≥n</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0" id="mb"></div></div></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, collection, addDoc, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "PON_AQUI_TU_API_KEY",
        authDomain: "PON_AQUI_TU_PROJECT.firebaseapp.com",
        projectId: "PON_AQUI_TU_PROJECT_ID",
        storageBucket: "PON_AQUI_TU_BUCKET.appspot.com",
        messagingSenderId: "PON_AQUI_TU_SENDER_ID",
        appId: "PON_AQUI_TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DOC_ACTIVE = doc(db, "sumaj_data", "hotel_active");
    const COL_HISTORY = collection(db, "sumaj_data", "hotel_active", "historial_collection"); 
    const COL_LOGS = collection(db, "sumaj_data", "hotel_active", "logs_collection");

    const ROLES_PERMISOS = {
        admin: ['all'],
        recepcion: ['nav-mapa', 'nav-calendario', 'nav-operaciones', 'nav-caja', 'nav-inventario'],
        limpieza: ['nav-limpieza']
    };

    let defaultHabs = [
        {num:101, piso:'Piso 1'}, {num:102, piso:'Piso 1'}, {num:103, piso:'Piso 1'}, {num:104, piso:'Piso 1'}, {num:105, piso:'Piso 1'}, {num:106, piso:'Piso 1'}, {num:107, piso:'Piso 1'}, {num:108, piso:'Piso 1'},
        {num:201, piso:'Piso 2'}, {num:202, piso:'Piso 2'}, {num:203, piso:'Piso 2'}, {num:204, piso:'Piso 2'}, {num:205, piso:'Piso 2'}, {num:206, piso:'Piso 2'}, {num:207, piso:'Piso 2'}, {num:208, piso:'Piso 2'},
        {num:1, piso:'Departamento', tipo:'Familiar'}, {num:2, piso:'Departamento', tipo:'Matrimonial Vista'}, {num:3, piso:'Departamento', tipo:'Matrimonial'},
        {num:4, piso:'Muelle', tipo:'Matrimonial Muelle'}, {num:5, piso:'Muelle', tipo:'Matrimonial Muelle'}
    ];

    let habs = defaultHabs; let ress = []; let inventario = []; let caja = []; 
    let users = [{ user: 'admin', pass: 'admin707', role: 'admin' }]; 
    let limpieza = {}; let historialCache = []; 
    let currentUser = null; let modalInstance = null; let modalNuevoIngreso = null; 
    let calDate = new Date(); 
    const now = new Date(); const offset = now.getTimezoneOffset() * 60000; const localDate = new Date(now.getTime() - offset); const hoy = localDate.toISOString().split('T')[0];
    const { jsPDF } = window.jspdf;

    async function saveActiveData() {
        document.getElementById('cloudLoader').style.display = 'block';
        try { await setDoc(DOC_ACTIVE, { habs, ress, inventario, caja, users, limpieza, lastUpdate: new Date().toISOString() }); } 
        catch (e) { console.error(e); Swal.fire({icon: 'error', title: 'Error Guardando', toast: true, position: 'top-end', timer: 3000}); }
        document.getElementById('cloudLoader').style.display = 'none';
    }

    function initRealtimeListener() {
        onSnapshot(DOC_ACTIVE, (docSnap) => {
            if (docSnap.exists()) {
                const d = docSnap.data();
                habs = d.habs || defaultHabs; ress = d.ress || []; inventario = d.inventario || []; caja = d.caja || []; users = d.users || users; limpieza = d.limpieza || {};
                if (!currentUser) {
                    const sessionUser = localStorage.getItem('sumaj_session');
                    if (sessionUser) {
                        const found = users.find(u => u.user === sessionUser);
                        if (found) {
                            currentUser = found;
                            document.getElementById('loginOverlay').style.display = 'none';
                            document.getElementById('appInterface').style.display = 'block';
                            document.getElementById('userDisplay').innerText = `üë§ ${currentUser.user.toUpperCase()} (${currentUser.role.toUpperCase()})`;
                            funcs.aplicarPermisos(); funcs.initSystem();
                        }
                    }
                }
                if(currentUser) { funcs.actualizarPantalla(); funcs.renderCal(); funcs.renderLimpieza(); if(document.getElementById('tab-caja').classList.contains('active')) funcs.renderCaja(); }
            } else { saveActiveData(); }
        });
    }

    const funcs = {
        login: () => {
            const u = document.getElementById('loginUser').value; const p = document.getElementById('loginPass').value;
            const userFound = users.find(x => x.user === u && x.pass === p);
            if (userFound) {
                currentUser = userFound; localStorage.setItem('sumaj_session', userFound.user);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appInterface').style.display = 'block';
                document.getElementById('userDisplay').innerText = `üë§ ${currentUser.user.toUpperCase()} (${currentUser.role.toUpperCase()})`;
                funcs.aplicarPermisos(); funcs.registrarLog("LOGIN", "Ingreso al sistema"); funcs.initSystem();
            } else { Swal.fire({icon: 'error', title: 'Acceso Denegado', showConfirmButton: false, timer: 1500}); }
        },
        logout: () => { localStorage.removeItem('sumaj_session'); location.reload(); },
        
        aplicarPermisos: () => {
            document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'none');
            const allowedModules = ROLES_PERMISOS[currentUser.role] || [];
            let firstTab = null;
            if (currentUser.role === 'admin' || allowedModules.includes('all')) {
                document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'block');
                firstTab = '#tab-mapa';
            } else {
                allowedModules.forEach(modId => { const el = document.getElementById(modId); if(el) { el.style.display = 'block'; if(!firstTab) firstTab = el.querySelector('button').getAttribute('data-bs-target'); } });
            }
            if(firstTab) { const triggerEl = document.querySelector(`button[data-bs-target="${firstTab}"]`); if(triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show(); }
        },

        initSystem: () => {
            document.getElementById('checkin').value = hoy; document.getElementById('checkout').value = hoy; document.getElementById('filtroFecha').value = hoy; document.getElementById('fechaOp').value = hoy;
            calDate = new Date(); calDate.setDate(1); funcs.actualizarPantalla(); funcs.renderConfigHabs(); funcs.renderCal(); 
            if(funcs.checkPermiso('nav-caja')) funcs.renderCaja(); if(funcs.checkPermiso('nav-inventario')) funcs.renderInventario();
            if(funcs.checkPermiso('nav-usuarios')) funcs.renderUsuarios(); 
            funcs.renderLimpieza();
            setInterval(()=>document.getElementById('reloj').innerText=new Date().toLocaleString(),1000);
        },

        registrarLog: async (accion, detalle) => { try { await addDoc(COL_LOGS, { dateIso: new Date().toISOString(), dateStr: new Date().toLocaleString(), user: currentUser ? currentUser.user : 'system', action: accion, details: detalle }); } catch(e) { console.error(e); } },
        renderLogs: async () => {
            if(!funcs.verificarPermisoAdmin()) return;
            const t=document.getElementById('tablaLogs'); t.innerHTML='<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>';
            try { const q = query(COL_LOGS, orderBy("dateIso", "desc"), limit(50)); const qs = await getDocs(q); t.innerHTML = ''; qs.forEach((doc) => { const l = doc.data(); t.innerHTML += `<tr><td>${l.dateStr}</td><td>${l.user}</td><td>${l.action}</td><td>${l.details}</td></tr>`; }); } catch(e) { t.innerHTML='<tr><td colspan="4" class="text-danger">Error</td></tr>'; }
        },

        checkPermiso: (modId) => { if(currentUser.role === 'admin') return true; return (ROLES_PERMISOS[currentUser.role] || []).includes(modId); },
        verificarPermisoAdmin: () => { if (currentUser.role === 'admin') return true; Swal.fire({icon:'warning', title:'Sin Permiso', text:'Funci√≥n solo para Administrador'}); return false; },

        abrirModalNuevaReserva: () => {
            if(!modalNuevoIngreso) modalNuevoIngreso = new bootstrap.Modal(document.getElementById('modalNuevoIngreso'));
            document.getElementById('cliente').value = ''; document.getElementById('cliente').classList.remove('found-client'); document.getElementById('dni').value = ''; document.getElementById('numPersonas').value = '1'; document.getElementById('c_celular').value = ''; document.getElementById('total').value = '0'; document.getElementById('adelanto').value = '0';
            document.getElementById('checkin').value = hoy; document.getElementById('checkout').value = hoy;
            funcs.toggleAdelanto(); funcs.checkTipoHab('mapa'); modalNuevoIngreso.show();
        },
        buscarCliente: async (dni) => {
            if (dni.length < 8) return; let previo = ress.find(x => x.dni === dni);
            if (previo) { const elCliente = document.getElementById('cliente'); elCliente.value = previo.cliente; document.getElementById('c_celular').value = previo.celular || ''; elCliente.classList.add('found-client'); setTimeout(() => elCliente.classList.remove('found-client'), 1500); }
        },
        guardarReserva: async () => { 
            const d=(id)=>document.getElementById(id).value; const t=parseFloat(d('total'))||0; let ad=d('pagoEstado')==='Pagado'?t:(d('pagoEstado')==='Adelanto'?parseFloat(d('adelanto')):0); 
            if(!d('cliente')) return Swal.fire('Error', 'Falta nombre', 'warning'); 
            const selHab = parseInt(d('habSelect')); let tipo = d('tipoHab');
            if(document.getElementById('tipoHab').disabled) { const hObj = habs.find(h=>h.num === selHab); if(hObj) tipo = hObj.tipo; }
            if(limpieza[selHab]==='sucia'||limpieza[selHab]==='limpieza'){ const result = await Swal.fire({title: 'Habitaci√≥n No Lista', text: '¬øAsignar igual?', icon: 'warning', showCancelButton: true}); if(!result.isConfirmed) return; } 
            if(!funcs.validarDisponibilidad(selHab,d('checkin'),d('checkout'))) return Swal.fire('Ocupado', 'Fechas ocupadas', 'error'); 
            ress.push({id:Date.now(),cliente:d('cliente'),dni:d('dni'),personas:d('numPersonas'),celular:d('c_celular'),habNum:selHab,tipo:tipo,in:d('checkin'),out:d('checkout'),total:t,adelanto:ad,medioPago:d('medioPago'),consumos:[]}); 
            saveActiveData(); funcs.registrarLog("RESERVA",`Hab ${d('habSelect')} - ${d('cliente')}`); 
            if(modalNuevoIngreso) modalNuevoIngreso.hide(); Swal.fire({icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false});
        },
        validarDisponibilidad: (h, i, o, excludeId = null) => { return !ress.some(r => { if(excludeId && r.id === excludeId) return false; return r.habNum == h && i < r.out && o > r.in; }); },
        editarReserva: (id) => { const r = ress.find(x => x.id == id); if(!r) return; const htmlForm = `<div class="row g-3 p-4"><h5 class="fw-bold mb-3 border-bottom pb-2">Editar Reserva</h5><div class="col-md-6"><label class="small fw-bold">Nombre</label><input type="text" id="edit_cliente" class="form-control" value="${r.cliente}"></div><div class="col-md-6"><label class="small fw-bold">DNI</label><input type="text" id="edit_dni" class="form-control" value="${r.dni||''}"></div><div class="col-md-6"><label class="small fw-bold">Celular</label><input type="text" id="edit_celular" class="form-control" value="${r.celular||''}"></div><div class="col-md-6"><label class="small fw-bold">Pax</label><input type="number" id="edit_personas" class="form-control" value="${r.personas||1}"></div><div class="col-md-6"><label class="small fw-bold">IN</label><input type="date" id="edit_in" class="form-control" value="${r.in}"></div><div class="col-md-6"><label class="small fw-bold">OUT</label><input type="date" id="edit_out" class="form-control" value="${r.out}"></div><div class="col-md-12"><label class="small fw-bold">Total S/</label><input type="number" id="edit_total" class="form-control fw-bold" value="${r.total}"></div><div class="col-12 mt-4 d-flex gap-2"><button class="btn btn-primary w-100" onclick="window.funcs.guardarEdicion(${r.id})">Guardar</button><button class="btn btn-secondary w-100" onclick="window.funcs.verDetalle(${r.habNum}, ${r.id})">Cancelar</button></div></div>`; document.getElementById('mb').innerHTML = htmlForm; },
        guardarEdicion: (id) => { const r = ress.find(x => x.id == id); if(!r) return; const nC=document.getElementById('edit_cliente').value, nD=document.getElementById('edit_dni').value, nCel=document.getElementById('edit_celular').value, nP=document.getElementById('edit_personas').value, nI=document.getElementById('edit_in').value, nO=document.getElementById('edit_out').value, nT=parseFloat(document.getElementById('edit_total').value)||0; if(!nC) return Swal.fire('Error','Falta nombre','error'); if(!funcs.validarDisponibilidad(r.habNum, nI, nO, r.id)) return Swal.fire('Conflicto', 'Fechas ocupadas', 'error'); r.cliente=nC; r.dni=nD; r.celular=nCel; r.personas=nP; r.in=nI; r.out=nO; r.total=nT; saveActiveData(); funcs.registrarLog("EDITAR", `Reserva ${r.id} modif`); funcs.verDetalle(r.habNum, r.id); },

        actualizarPantalla: () => {
            const f = document.getElementById('filtroFecha').value; const grid = document.getElementById('gridHabitaciones'); const select = document.getElementById('habSelect'); 
            grid.innerHTML = ''; select.innerHTML = ''; 
            const pisos = [...new Set(habs.map(h => h.piso))].sort();
            pisos.forEach(p => { 
                const label = String(p).includes('Piso') ? p : `SECCI√ìN ${p.toUpperCase()}`; grid.innerHTML += `<div class="col-12"><div class="piso-header mb-2">${label}</div></div>`; 
                const groupHabs = habs.filter(h => h.piso === p).sort((a,b)=>a.num-b.num);
                groupHabs.forEach(h => {
                    const r = ress.find(x => x.habNum == h.num && (f >= x.in && f <= x.out)); const stL = limpieza[h.num] || 'limpia'; 
                    let cc = 'hab-card', sb = '<span class="badge bg-success">Libre</span>', info = `<div class="small text-muted">Disponible</div>`;
                    if (r) { 
                        const tC = (r.consumos||[]).reduce((a,b)=>a+(b.precio*b.cantidad),0), deu = (r.total + tC) - r.adelanto; 
                        if (f === r.out) { cc += ' status-salida'; sb = `<span class="badge text-dark" style="background-color: var(--salida);">Salida Hoy</span>`; info = `<div class="small fw-bold text-dark text-truncate">${r.cliente}</div><div class="small fw-bold">Check-Out Pendiente</div>`; } 
                        else { cc += ' status-ocupado'; sb = `<span class="badge bg-danger">Ocupado</span>`; info = `<div class="small fw-bold text-primary text-truncate">${r.cliente}</div>${deu > 0.1 ? `<div class="small text-danger fw-bold">Deuda: S/ ${deu.toFixed(2)}</div>` : `<div class="small text-success fw-bold">Pagado</div>`}`; } 
                    } else if (stL === 'sucia') { cc += ' status-sucia'; sb = `<span class="badge bg-warning text-dark">Sucia</span>`; info = `<div class="small text-warning fw-bold">Limpieza Pendiente</div>`; } else if (stL === 'limpieza') { cc += ' status-limpieza'; sb = `<span class="badge bg-primary">Limpieza</span>`; info = `<div class="small text-primary fw-bold">Limpiando...</div>`; } else { cc += ' status-disponible'; }
                    const dN = h.piso.includes('Piso') ? h.num : String(h.num).padStart(3, '0');
                    grid.innerHTML += `<div class="col-xl-3 col-lg-3 col-md-3 col-sm-6 mb-3"><div class="${cc}" onclick="window.funcs.verDetalle(${h.num}, ${r?r.id:null})"><div class="card-body"><div class="d-flex justify-content-between mb-2"><b class="fs-5">${dN}</b>${sb}</div>${h.tipo ? `<div style="font-size:0.75rem" class="text-muted text-truncate mb-2">${h.tipo}</div>` : ''}${info}</div></div></div>`;
                    const opt = `<option value="${h.num}">${dN} ${h.tipo?`(${h.tipo})`:''}</option>`; select.innerHTML += opt;
                });
            });
            funcs.checkTipoHab('mapa');
        },
        checkTipoHab: (origin) => {
            const habId = origin === 'mapa' ? 'habSelect' : 'c_habSelect'; const tipoId = origin === 'mapa' ? 'tipoHab' : 'c_tipoHab';
            if(!document.getElementById(habId)) return;
            const selHab = parseInt(document.getElementById(habId).value); const selTipo = document.getElementById(tipoId);
            const habitacion = habs.find(h => h.num === selHab);
            if (habitacion) { if (habitacion.piso === 'Departamento' || habitacion.piso === 'Muelle') { selTipo.innerHTML = `<option value="${habitacion.tipo}" selected>${habitacion.tipo}</option>`; selTipo.disabled = true; } else { selTipo.disabled = false; selTipo.innerHTML = `<option>Simple</option><option>Matrimonial</option><option>Doble</option><option>Triple</option><option>Suite</option>`; } }
        },

        checkOut: async (id,d) => {
            if(d>0.1) return Swal.fire('Deuda Pendiente', 'El cliente debe cancelar su deuda antes de salir.', 'warning');
            const result = await Swal.fire({ title: '¬øConfirmar Salida?', text: "Esto finalizar√° la reserva.", icon: 'question', showCancelButton: true });
            if(!result.isConfirmed) return;
            const r = ress.find(x=>x.id==id); const tC = (r.consumos||[]).reduce((a,b)=>a+(b.precio*b.cantidad),0);
            const finalRes = { ...r, totalFinal: r.total+tC, fechaCierre: new Date().toISOString(), fechaCierreStr: new Date().toLocaleString() };
            document.getElementById('cloudLoader').style.display = 'block';
            try { await addDoc(COL_HISTORY, finalRes); ress = ress.filter(x=>x.id!==id); limpieza[r.habNum] = 'sucia'; await saveActiveData(); funcs.registrarLog("CHECK_OUT", `Hab ${r.habNum}`); modalInstance.hide(); funcs.actualizarPantalla(); funcs.renderCal(); funcs.renderLimpieza(); Swal.fire('Exitoso', 'La reserva se movi√≥ al historial.', 'success'); } 
            catch(e) { console.error(e); Swal.fire('Error', 'Revise conexi√≥n.', 'error'); }
            document.getElementById('cloudLoader').style.display = 'none';
        },

        verDetalle: (num,id,isH) => {
            if(!modalInstance)modalInstance=new bootstrap.Modal(document.getElementById('modalH'));
            let r; if(id) r = isH ? historialCache.find(x=>x.id==id) : ress.find(x=>x.id==id); else { const f=document.getElementById('filtroFecha').value; r=ress.find(x=>x.habNum==num&&(f>=x.in&&f<=x.out)); } 
            if(!r){
                const st=limpieza[num]||'limpia'; let b='', icon='';
                if(st==='sucia') { b=`<button class="btn btn-primary w-100" onclick="window.funcs.setEstadoLimpieza(${num},'limpieza');modalInstance.hide()">Empezar Limpieza</button>`; icon='<i class="fas fa-broom fa-3x text-warning mb-3"></i>'; } else if(st==='limpieza') { b=`<button class="btn btn-success w-100" onclick="window.funcs.setEstadoLimpieza(${num},'limpia');modalInstance.hide()">Terminar Limpieza</button>`; icon='<i class="fas fa-pump-soap fa-3x text-primary mb-3"></i>'; } else { b=`<button class="btn btn-warning w-100" onclick="window.funcs.setEstadoLimpieza(${num},'sucia');modalInstance.hide()">Marcar Sucia</button>`; icon='<i class="fas fa-check-circle fa-3x text-success mb-3"></i>'; }
                document.getElementById('mt').innerHTML = `<span class="badge bg-secondary">Hab ${num}</span> Estado`; document.getElementById('mb').innerHTML=`<div class="text-center py-5">${icon}<h5>${st.toUpperCase()}</h5><div class="mt-4 px-5">${b}</div></div>`; modalInstance.show(); return;
            }
            const cons = r.consumos || [], tCons = cons.reduce((a,b)=>a+(b.precio*b.cantidad),0), granT = isH ? r.totalFinal : (r.total+tCons), deu = isH ? 0 : (granT-r.adelanto);
            const hBtn = isH ? 'display:none' : ''; let ops = '<option value="">Agregar...</option>'; inventario.forEach(p => ops += `<option value="${p.id}">${p.nombre} - S/${p.precio}</option>`);
            let badgeEstado = ''; if(isH) badgeEstado = '<span class="badge bg-secondary">Historial</span>'; else if(deu < 0.1) badgeEstado = '<span class="badge bg-success">Pagado</span>'; else badgeEstado = '<span class="badge bg-danger">Falta Pago</span>';
            document.getElementById('mt').innerHTML = `<div class="d-flex align-items-center gap-2"><span class="badge bg-dark fs-5">HAB ${num}</span>${badgeEstado}</div>`;
            let html = `<div class="row g-0"><div class="col-lg-7 p-4 border-end"><div class="d-flex justify-content-between align-items-center mb-2"><div class="detail-label">Hu√©sped</div>${!isH ? `<button class="btn btn-sm btn-outline-primary py-0" style="font-size:0.7rem;" onclick="window.funcs.editarReserva(${r.id})"><i class="fas fa-edit"></i> Editar</button>` : ''}</div><div class="row g-3 mb-4"><div class="col-12"><div class="detail-value fs-5"><i class="fas fa-user-circle text-secondary me-2"></i>${r.cliente}</div></div><div class="col-6"><div class="detail-label">Check-In</div><div class="detail-value text-success">${r.in}</div></div><div class="col-6"><div class="detail-label">Check-Out</div><div class="detail-value text-danger">${r.out}</div></div><div class="col-6"><div class="detail-label">Pax</div><div class="detail-value">${r.personas}</div></div><div class="col-6"><div class="detail-label">Contacto</div><div class="detail-value">${r.celular||'-'}</div></div></div><hr class="text-muted opacity-25"><h6 class="fw-bold m-0 text-primary mb-2">Consumos</h6><div class="input-group input-group-sm mb-3" style="${hBtn}"><select id="selP" class="form-select border-primary">${ops}</select><input id="selQ" type="number" value="1" class="form-control border-primary" style="max-width: 60px;"><button class="btn btn-primary" onclick="window.funcs.addCons(${r.id})">+</button></div><div class="table-responsive border rounded bg-white" style="max-height: 200px; overflow-y:auto;"><table class="table table-sm table-striped m-0 cons-table"><thead><tr><th>Cant</th><th>Item</th><th class="text-end">Total</th><th class="text-center" style="${hBtn}">X</th></tr></thead><tbody>${cons.length > 0 ? cons.map((c,i) => `<tr><td class="text-center fw-bold">${c.cantidad}</td><td>${c.item}</td><td class="text-end">S/ ${(c.precio*c.cantidad).toFixed(2)}</td><td class="text-center" style="${hBtn}"><i class="fas fa-trash text-danger cursor-pointer" onclick="window.funcs.delCons(${r.id},${i})"></i></td></tr>`).join('') : '<tr><td colspan="4" class="text-center text-muted small">Sin consumos</td></tr>'}</tbody></table></div></div><div class="col-lg-5 p-4 bg-light d-flex flex-column"><h6 class="fw-bold text-dark mb-3">Finanzas</h6><div class="total-box mb-4 shadow-sm"><div class="d-flex justify-content-between mb-1"><span class="text-muted">Aloj:</span><span class="fw-bold">S/ ${r.total.toFixed(2)}</span></div><div class="d-flex justify-content-between mb-2"><span class="text-muted">Cons:</span><span class="fw-bold">S/ ${tCons.toFixed(2)}</span></div><hr class="my-2"><div class="d-flex justify-content-between mb-1"><span class="fs-5 fw-bold text-dark">TOTAL:</span><span class="fs-5 fw-bold text-dark">S/ ${granT.toFixed(2)}</span></div><div class="d-flex justify-content-between mb-1"><span class="text-success fw-bold">Pagado:</span><span class="text-success fw-bold">- S/ ${r.adelanto.toFixed(2)}</span></div><div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top"><span class="fw-bold text-danger">DEUDA:</span><span class="${deu > 0.1 ? 'debt-high' : 'debt-ok'}">S/ ${deu.toFixed(2)}</span></div></div><div class="mt-auto d-grid gap-2">${!isH && deu > 0.1 ? `<button class="btn btn-success fw-bold py-2 shadow-sm" onclick="window.funcs.pay(${r.id},${deu})">COBRAR</button>` : ''}<div class="btn-group" role="group"><button class="btn btn-outline-secondary" onclick="window.funcs.printTicket(${r.id},${isH})"><i class="fas fa-print"></i></button>${!isH ? `<button class="btn btn-outline-success" onclick="window.funcs.enviarWhatsapp(${r.id})"><i class="fab fa-whatsapp"></i></button>` : ''}</div>${!isH ? `<button class="btn btn-dark fw-bold py-2 mt-2" onclick="window.funcs.checkOut(${r.id},${deu})">CHECKOUT</button>` : ''}</div></div></div>`; document.getElementById('mb').innerHTML = html; modalInstance.show();
        },
        
        printTicket: (id, isH) => {
            const r = isH ? historialCache.find(x => x.id == id) : ress.find(x => x.id == id); if (!r) return;
            const cons = r.consumos || []; const tCons = cons.reduce((a, b) => a + (b.precio * b.cantidad), 0); const totalG = isH ? r.totalFinal : (r.total + tCons);
            const ventana = window.open('', 'PRINT', 'height=600,width=400');
            ventana.document.write(`<html><head><style>body { font-family: 'Courier New', monospace; width: 80mm; font-size: 12px; margin: 0; padding: 5px; } .center { text-align: center; } .line { border-bottom: 1px dashed #000; margin: 5px 0; } .flex { display: flex; justify-content: space-between; } .bold { font-weight: bold; }</style></head><body><div class="center"><div class="bold" style="font-size:16px">SUMAJ LAGOON LODGE</div><div>Sauce - San Mart√≠n</div><div>RUC: 20XXXXXXXXX</div></div><div class="line"></div><div>Fecha: ${new Date().toLocaleString()}</div><div>Cliente: ${r.cliente}</div><div>DNI: ${r.dni || '-'}</div><div class="line"></div><div class="flex"><span>HABITACI√ìN ${r.habNum}</span><span>S/ ${r.total.toFixed(2)}</span></div><div style="font-size:10px; color:#555">Del ${r.in} al ${r.out}</div>${cons.length > 0 ? '<div class="line"></div><div class="bold">CONSUMOS:</div>' : ''}${cons.map(c => `<div class="flex"><span>${c.cantidad} x ${c.item.substring(0,15)}</span><span>S/ ${(c.precio*c.cantidad).toFixed(2)}</span></div>`).join('')}<div class="line"></div><div class="flex bold" style="font-size:14px"><span>TOTAL:</span><span>S/ ${totalG.toFixed(2)}</span></div><div class="flex"><span>A Cuenta:</span><span>S/ ${r.adelanto.toFixed(2)}</span></div><div class="flex bold"><span>SALDO:</span><span>S/ ${(isH ? 0 : totalG - r.adelanto).toFixed(2)}</span></div><div class="line"></div><div class="center" style="margin-top:10px;">¬°Gracias por su visita!</div></body></html>`); ventana.document.close(); ventana.focus(); setTimeout(() => { ventana.print(); ventana.close(); }, 500);
        },
        setEstadoLimpieza: (num, estado) => { limpieza[num] = estado; saveActiveData(); funcs.registrarLog("LIMPIEZA", `Hab ${num} a ${estado}`); },
        addCons: (id) => { const pid = parseInt(document.getElementById('selP').value); const q = parseInt(document.getElementById('selQ').value); const p = inventario.find(i => i.id === pid); if(!p) return; if(p.tipo === 'producto') { if(p.stock < q) return Swal.fire('Sin Stock', `Solo quedan ${p.stock} unidades.`, 'error'); p.stock -= q; } const r = ress.find(x => x.id == id); if(!r.consumos) r.consumos = []; r.consumos.push({ idProd: p.id, item: p.nombre, precio: p.precio, cantidad: q, tipo: p.tipo }); saveActiveData(); funcs.verDetalle(r.habNum, id); },
        delCons: (id, i) => { const r = ress.find(x => x.id == id); const it = r.consumos[i]; if(it.idProd && it.tipo === 'producto') { const p = inventario.find(x => x.id === it.idProd); if(p) { p.stock += it.cantidad; } } r.consumos.splice(i, 1); saveActiveData(); funcs.verDetalle(r.habNum, id); },
        pay: async (id,m) => { const result = await Swal.fire({title: 'Cobrar Saldo', text: `¬øCobrar S/ ${m.toFixed(2)}?`, icon: 'info', showCancelButton: true}); if(result.isConfirmed){const r=ress.find(x=>x.id==id);r.adelanto+=m;saveActiveData();funcs.verDetalle(r.habNum,id);funcs.renderCal();} },
        enviarWhatsapp: (id) => { const r = ress.find(x => x.id == id); if (!r) return; const msg = `*HOLA, ${r.cliente.toUpperCase()}* üå¥%0AConfirmado:%0AüìÖ IN: ${r.in}%0AüìÖ OUT: ${r.out}%0Aüè† Hab: ${r.habNum}%0Aüí∞ Total: S/ ${r.total}%0Aüíµ A cuenta: S/ ${r.adelanto}`; let cel = r.celular.replace(/\D/g, ''); if (cel.length === 9) cel = '51' + cel; window.open(`https://wa.me/${cel}?text=${msg}`, '_blank'); },
        exportarCalImg: () => { html2canvas(document.getElementById('calContainer')).then(canvas => { const link=document.createElement('a'); link.download=`Calendario_${hoy}.png`; link.href=canvas.toDataURL(); link.click(); }); },
        exportarCalPDF: () => { html2canvas(document.getElementById('calContainer')).then(canvas => { const imgData=canvas.toDataURL('image/png'); const pdf=new jsPDF('landscape'); const imgProps=pdf.getImageProperties(imgData); const pdfWidth=pdf.internal.pageSize.getWidth(); const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width; pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight); pdf.save(`Calendario_${hoy}.pdf`); }); },

        renderCal: () => {
            const t = document.getElementById('tablaCal'); t.innerHTML = '';
            const y = calDate.getFullYear(), m = calDate.getMonth(), days = new Date(y, m + 1, 0).getDate();
            document.getElementById('calMesTitulo').innerText = `${["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][m]} ${y}`;
            let head = '<thead><tr><th class="cal-room-col">HAB</th>';
            const ds = []; for(let i=1;i<=days;i++){ const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; ds.push(iso); head+=`<th class="${iso===hoy?'cal-today-col':''}">${i}</th>`; } head+='</tr></thead><tbody>';
            const getColor = (r, isHist) => { if(isHist) return 'var(--historial)'; if(r.out === hoy) return 'var(--salida)'; return 'var(--ocupado)'; };
            habs.forEach(h => {
                head+=`<tr><td class="cal-room-col">${h.piso.includes('Piso')?h.num:h.num}</td>`;
                ds.forEach(d => {
                    const activeRes = ress.find(x => x.habNum == h.num && d >= x.in && d <= x.out);
                    let bg = 'white'; let clickId = null;
                    if(activeRes) {
                         bg = getColor(activeRes, false);
                         if (activeRes.in === d && activeRes.out !== d) bg = `linear-gradient(to right, white 50%, ${bg} 50%)`; else if (activeRes.out === d && activeRes.in !== d) bg = `linear-gradient(to right, ${bg} 50%, white 50%)`;
                         clickId = activeRes.id;
                    }
                    let tooltipInfo = ""; if (activeRes) tooltipInfo = `title="${activeRes.cliente}"`;
                    head+=`<td class="cal-cell" style="background:${bg}" ${tooltipInfo} onclick="window.funcs.verDetalle(${h.num},${clickId})"></td>`;
                }); head+='</tr>';
            }); t.innerHTML=head+'</tbody>';
        },

        navMes: (d) => { calDate.setMonth(calDate.getMonth() + d); calDate.setDate(1); funcs.renderCal(); },
        guardarMovimientoCaja: () => { const t=document.getElementById('cajaTipo').value,d=document.getElementById('cajaDesc').value,m=parseFloat(document.getElementById('cajaMonto').value);if(!d||!m)return;caja.push({id:Date.now(),fecha:new Date().toLocaleString(),tipo:t,cat:document.getElementById('cajaCat').value,desc:d,monto:m});saveActiveData();funcs.renderCaja();document.getElementById('cajaDesc').value='';document.getElementById('cajaMonto').value=''; },
        renderCaja: () => { const t=document.getElementById('bodyCaja');t.innerHTML='';let s=0;[...caja].reverse().forEach(m=>{if(m.tipo==='ingreso')s+=m.monto;else s-=m.monto;t.innerHTML+=`<tr><td>${m.fecha.split(',')[0]}</td><td>${m.tipo}</td><td>${m.cat}</td><td>${m.desc}</td><td>S/${m.monto}</td><td><button class="btn btn-sm text-danger" onclick="window.funcs.delCaja(${m.id})">x</button></td></tr>`;});document.getElementById('cajaSaldo').innerText=`S/${s.toFixed(2)}`; },
        delCaja: async (id) => { if(funcs.verificarPermisoAdmin()){ const r=await Swal.fire({title:'¬øBorrar?',icon:'warning',showCancelButton:true}); if(r.isConfirmed){caja=caja.filter(x=>x.id!==id);saveActiveData();funcs.renderCaja();} } },
        agregarProducto: () => { if(!funcs.checkPermiso('nav-inventario'))return;const t=document.getElementById('invTipo').value,n=document.getElementById('invNombre').value,p=parseFloat(document.getElementById('invPrecio').value);let s=parseInt(document.getElementById('invStock').value);if(!n)return;if(t==='servicio')s=9999;inventario.push({id:Date.now(),nombre:n,precio:p,stock:s,tipo:t});saveActiveData();funcs.renderInventario(); },
        renderInventario: () => { const t=document.getElementById('tablaInventario');t.innerHTML='';inventario.forEach(p=>{t.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.tipo}</td><td>${p.precio}</td><td>${p.tipo==='servicio'?'-':p.stock}</td><td><button class="btn btn-sm btn-danger" onclick="window.funcs.delInv(${p.id})">x</button></td></tr>`;}); },
        delInv: async (id) => { if(funcs.verificarPermisoAdmin()){ const r=await Swal.fire({title:'¬øBorrar?',icon:'warning',showCancelButton:true}); if(r.isConfirmed){inventario=inventario.filter(x=>x.id!==id);saveActiveData();funcs.renderInventario();} } },
        actualizarOperaciones: () => { const f=document.getElementById('fechaOp').value,i=document.getElementById('listIn'),o=document.getElementById('listOut');i.innerHTML='';o.innerHTML='';ress.forEach(r=>{let h=`<div class="op-card ${r.in===f?'op-in':'op-out'}"><b>${r.habNum}</b> ${r.cliente}</div>`;if(r.in===f)i.innerHTML+=h;if(r.out===f)o.innerHTML+=h;}); },
        toggleAdelanto: () => { document.getElementById('divAdelanto').style.display=document.getElementById('pagoEstado').value==='Adelanto'?'block':'none'; },
        toggleStockInput: () => { const t=document.getElementById('invTipo').value;document.getElementById('divStockInput').style.display=t==='servicio'?'none':'block'; },
        limpiarFormUsuario: () => { document.getElementById('newUserName').value=''; document.getElementById('newUserPass').value=''; document.getElementById('editUserIndex').value='-1'; },
        guardarUsuario: () => { 
            if(!funcs.verificarPermisoAdmin()) return;
            const u = document.getElementById('newUserName').value; const p = document.getElementById('newUserPass').value; const role = document.getElementById('newUserRole').value; const idx = parseInt(document.getElementById('editUserIndex').value);
            if(!u || !p) return;
            if(idx === -1) users.push({user:u, pass:p, role:role}); else { users[idx].user=u; users[idx].pass=p; users[idx].role=role; }
            saveActiveData(); funcs.renderUsuarios(); funcs.limpiarFormUsuario(); 
        },
        renderUsuarios: () => { const t=document.getElementById('tablaUsuarios'); t.innerHTML=''; users.forEach((u,i)=>{ t.innerHTML+=`<tr><td>${u.user}</td><td>***</td><td>${u.role.toUpperCase()}</td><td>${u.user!=='admin'?`<button class="btn btn-sm btn-info" onclick="window.funcs.editUser(${i})">E</button><button class="btn btn-sm btn-danger" onclick="window.funcs.delUser('${u.user}')">x</button>`:''}</td></tr>`}); },
        editUser: (i) => { const u=users[i]; document.getElementById('editUserIndex').value=i; document.getElementById('newUserName').value=u.user; document.getElementById('newUserPass').value=u.pass; document.getElementById('newUserRole').value=u.role; },
        delUser: async (u) => { if(funcs.verificarPermisoAdmin()){const r=await Swal.fire({title:'¬øEliminar Usuario?',icon:'warning',showCancelButton:true}); if(r.isConfirmed){users=users.filter(x=>x.user!==u);saveActiveData();funcs.renderUsuarios();}} },
        imprimirLogs: () => { const w=window.open('');w.document.write(document.getElementById('printLogsArea').innerHTML);w.print(); },
        renderConfigHabs: () => { const t=document.getElementById('bodyConfigHabs');t.innerHTML='';habs.sort((a,b)=>{if(a.piso<b.piso)return -1;if(a.piso>b.piso)return 1;return a.num-b.num;});habs.forEach(h=>{t.innerHTML+=`<tr><td class="fw-bold">${h.num}</td><td>${h.piso}</td><td><button class="btn btn-sm btn-outline-danger" onclick="window.funcs.eliminarHabConfig(${h.num})">Trash</button></td></tr>`;}); },
        agregarHabitacion: () => { if(!funcs.checkPermiso('nav-config'))return;const n=parseInt(document.getElementById('confNum').value),p=document.getElementById('confPiso').value;if(n&&p){if(habs.some(h=>h.num===n))return Swal.fire('Error','Ya existe','error');habs.push({num:n,piso:p});saveActiveData();funcs.renderConfigHabs();} },
        eliminarHabConfig: async (n) => { if(funcs.checkPermiso('nav-config')){const r=await Swal.fire({title:'¬øEliminar?',icon:'warning',showCancelButton:true});if(r.isConfirmed){habs=habs.filter(h=>h.num!=n);saveActiveData();funcs.renderConfigHabs();}} },
        renderLimpieza: () => {
            const listS = document.getElementById('listSucias'); const listL = document.getElementById('listLimpias'); listS.innerHTML = ''; listL.innerHTML = '';
            const sucias = habs.filter(h => limpieza[h.num] === 'sucia' || limpieza[h.num] === 'limpieza');
            if(sucias.length === 0) listS.innerHTML = '<div class="text-muted small">Todo limpio</div>';
            sucias.forEach(h => {
                const st = limpieza[h.num]; const bg = st === 'sucia' ? 'bg-warning bg-opacity-25' : 'bg-primary bg-opacity-25';
                const btn = st === 'sucia' ? `<button class="btn btn-sm btn-primary" onclick="window.funcs.setEstadoLimpieza(${h.num}, 'limpieza')">Iniciar</button>` : `<button class="btn btn-sm btn-success" onclick="window.funcs.setEstadoLimpieza(${h.num}, 'limpia')">Terminar</button>`;
                listS.innerHTML += `<div class="d-flex justify-content-between align-items-center p-2 mb-2 rounded ${bg}"><div><span class="fw-bold">Hab ${h.num}</span> <span class="small">(${st})</span></div>${btn}</div>`;
            });
            listL.innerHTML = `<div class="alert alert-success">Total Habitaciones Limpias: ${habs.length - sucias.length}</div>`;
        }
    };

    window.funcs = funcs;
    initRealtimeListener();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA SUMAJ - v21.1 (Calendario Pro)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* COLORES ACTUALIZADOS */
        :root { 
            --disponible:#2ecc71; 
            --ocupado:#e74c3c;   /* ROJO PARA OCUPADO */
            --historial:#7f8c8d; /* GRIS PARA CHECK-OUT REALIZADO */
            --sucia: #f1c40f; 
            --limpieza: #3498db; 
            --parcial:#f39c12; 
            --pagado:#2980b9; 
            --dark:#1a2a3a; 
            --accent:#3498db; 
        }
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: var(--dark) !important; border-bottom: 3px solid var(--accent); }
        .nav-link.active { color: var(--accent) !important; border-bottom: 3px solid var(--accent) !important; }
        
        /* Cards */
        .hab-card { border-radius: 15px; border: 1px solid #dee2e6; transition: 0.3s; cursor: pointer; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-left: 12px solid transparent; position: relative; overflow: hidden; height: 100%; }
        .hab-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .status-disponible { border-left-color: var(--disponible); } .status-ocupado { border-left-color: var(--ocupado); background: #fff5f5; } .status-sucia { border-left-color: var(--sucia); background: #fffff0; } .status-limpieza { border-left-color: var(--limpieza); background: #f0f8ff; }
        .piso-header { background: #cbd5e0; color: #2d3748; padding: 8px 15px; border-radius: 8px; margin-top: 30px; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; }
        
        /* Calendario Mejorado CSS */
        .cal-wrapper { overflow-x: auto; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table-calendar { font-size: 0.75rem; border-collapse: separate; border-spacing: 1px; width: 100%; min-width: 900px; }
        .table-calendar th { text-align: center; background: #343a40; color: white; padding: 8px; position: sticky; top: 0; z-index: 20; }
        .cal-room-col { background: #212529; color: white; position: sticky; left: 0; z-index: 30; font-weight: bold; width: 60px; text-align: center; }
        .cal-cell { 
            height: 40px; 
            border: 1px solid #dee2e6; 
            padding: 0; 
            position: relative; 
            background-color: #fff; 
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        .cal-cell:hover { opacity: 0.8; }
        .cal-today-col { border-bottom: 3px solid #ffc107 !important; background-color: #fffbe6; }
        
        /* Utils Generales */
        .clean-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .clean-sucia { border-left-color: var(--sucia); } .clean-limpieza { border-left-color: var(--limpieza); } .clean-ok { border-left-color: var(--disponible); opacity: 0.8; }
        .op-card { font-size: 0.9rem; margin-bottom: 8px; border-left: 5px solid #ccc; background: white; padding: 12px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; } .op-in { border-left-color: #2ecc71; } .op-out { border-left-color: #e74c3c; }
        
        /* LOGIN & MODAL */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('nuestra-habitacion-matrimonial.jpg') no-repeat center center; background-size: cover; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 3rem; border-radius: 8px; width: 100%; max-width: 400px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); text-align: center; backdrop-filter: blur(2px); }
        .btn-login-custom { background-color: #6d4c41; border: none; color: white; transition: 0.3s; } .btn-login-custom:hover { background-color: #5d4037; color: white; }
        .detail-header { background-color: #f8f9fa; border-bottom: 1px solid #e9ecef; } .detail-label { font-size: 0.7rem; text-transform: uppercase; color: #6c757d; font-weight: 700; } .detail-value { font-size: 0.95rem; font-weight: 600; color: #2d3748; }
        .total-box { background: linear-gradient(to right, #f8f9fa, #fff); border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; } .debt-high { color: #dc3545; font-size: 1.4rem; font-weight: 800; } .debt-ok { color: #198754; font-size: 1.4rem; font-weight: 800; }
        
        /* LOADER FIREBASE */
        #cloudStatus { position: fixed; bottom: 10px; right: 10px; z-index: 9999; font-size: 0.8rem; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; }
    </style>
</head>
<body>

<div id="cloudStatus"><i class="fas fa-circle text-danger me-1"></i>Desconectado</div>

<div id="loginOverlay">
    <div class="login-card">
        <h2 class="fw-bold mb-4" style="color: #3e2723; font-size: 2rem; letter-spacing: 1px;">SUMAJ LODGE</h2>
        <div class="mb-3 text-start"><label class="form-label fw-bold text-secondary small">USUARIO</label><input type="text" id="loginUser" class="form-control form-control-lg bg-white border-secondary-subtle"></div>
        <div class="mb-4 text-start"><label class="form-label fw-bold text-secondary small">CONTRASE√ëA</label><input type="password" id="loginPass" class="form-control form-control-lg bg-white border-secondary-subtle"></div>
        <button class="btn btn-login-custom w-100 fw-bold py-3 fs-6 shadow-sm" id="btnLogin">INGRESAR</button>
    </div>
</div>

<div id="appInterface" style="display:none;">
    <nav class="navbar navbar-expand shadow mb-4">
        <div class="container-fluid px-4">
            <span class="navbar-brand fw-bold text-white"><i class="fas fa-hotel me-2"></i>SUMAJ LAGOON LODGE <span class="badge bg-warning text-dark ms-2" style="font-size:0.6rem">CLOUD v21.1</span></span>
            <div class="d-flex align-items-center gap-3">
                <div class="text-white small text-end"><div id="userDisplay" class="fw-bold text-warning"></div><div id="reloj" class="fw-light"></div></div>
                <button class="btn btn-sm btn-outline-light" onclick="window.funcs.logout()"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <ul class="nav nav-tabs mb-4 border-0" id="mainTabs">
            <li class="nav-item" id="nav-mapa"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-mapa">üó∫Ô∏è MAPA</button></li>
            <li class="nav-item" id="nav-limpieza"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-limpieza" onclick="window.funcs.renderLimpieza()">üßπ LIMPIEZA</button></li>
            <li class="nav-item" id="nav-calendario"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-calendario" onclick="window.funcs.renderCal()">üìÖ CALENDARIO</button></li>
            <li class="nav-item" id="nav-operaciones"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-operaciones" onclick="window.funcs.actualizarOperaciones()">üìã OPERACIONES</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-caja" onclick="window.funcs.renderCaja()">üí∞ CAJA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inventario">üì¶ ALMAC√âN</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-reporte" onclick="window.funcs.actualizarReporte()">üìä REPORTES</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-usuarios" onclick="window.funcs.renderUsuarios()">üë• USUARIOS</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-auditoria" onclick="window.funcs.renderLogs()">üëÅÔ∏è AUDITOR√çA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-config" onclick="window.funcs.renderConfigHabs()">‚öôÔ∏è CONFIGURACI√ìN</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-mapa"><div class="col-12"><div class="d-flex justify-content-between align-items-center mb-3 bg-white p-3 rounded shadow-sm"><div class="d-flex align-items-center gap-3"><span class="small fw-bold text-muted">VISTA: HOY</span><div class="d-flex gap-2 small"><span class="badge bg-success">Libre</span><span class="badge bg-danger">Ocupado</span><span class="badge bg-warning text-dark">Sucia</span><span class="badge bg-primary">Limpieza</span></div></div><div class="d-flex align-items-center gap-2"><button class="btn btn-primary fw-bold shadow-sm" onclick="window.funcs.abrirModalNuevaReserva()">‚ûï NUEVA RESERVA</button><input type="date" id="filtroFecha" class="form-control w-auto shadow-sm" onchange="window.funcs.actualizarPantalla()"></div></div><div id="gridHabitaciones" class="row g-3"></div></div></div>
            <div class="tab-pane fade" id="tab-limpieza"><div class="card p-4 border-0 shadow-sm"><h5 class="fw-bold mb-4"><i class="fas fa-broom"></i> Gesti√≥n de Limpieza</h5><div class="row"><div class="col-md-6 border-end"><h6 class="text-danger fw-bold border-bottom pb-2">SUCIAS / EN PROCESO</h6><div id="listSucias" class="mt-3"></div></div><div class="col-md-6"><h6 class="text-success fw-bold border-bottom pb-2">LISTAS</h6><div id="listLimpias" class="mt-3"></div></div></div></div></div>
            <div class="tab-pane fade" id="tab-calendario"><div class="card border-0 shadow-sm p-3"><div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mb-3 bg-light p-2 rounded"><div class="d-flex align-items-center gap-2"><button class="btn btn-sm btn-outline-dark" onclick="window.funcs.navMes(-1)"><i class="fas fa-chevron-left"></i></button><h6 class="m-0 fw-bold text-uppercase" id="calMesTitulo" style="min-width: 150px; text-align:center;"></h6><button class="btn btn-sm btn-outline-dark" onclick="window.funcs.navMes(1)"><i class="fas fa-chevron-right"></i></button></div><button class="btn btn-primary btn-sm fw-bold shadow-sm ms-2" onclick="window.funcs.abrirModalReservaCal()">‚ûï NUEVA RESERVA</button><div class="d-flex gap-2"><button class="btn btn-sm btn-danger" onclick="window.funcs.exportarCalPDF()"><i class="fas fa-file-pdf"></i></button><button class="btn btn-sm btn-dark" onclick="window.funcs.exportarCalImg()"><i class="fas fa-image"></i></button></div><input type="hidden" id="calInicio"><input type="hidden" id="calFin"></div><div id="calContainer" class="cal-wrapper"><table class="table-calendar" id="tablaCal"></table></div></div></div>
            <div class="tab-pane fade" id="tab-operaciones"><div class="card p-4 border-0 shadow-sm"><div class="d-flex justify-content-between mb-4"><h5 class="fw-bold">Reporte Operativo</h5><div class="d-flex gap-2"><input type="date" id="fechaOp" class="form-control w-auto" onchange="window.funcs.actualizarOperaciones()"><button class="btn btn-outline-secondary btn-sm" onclick="window.funcs.imprimirOp()">Imprimir</button></div></div><div id="opArea" class="row g-4"><div class="col-md-6 border-end"><h6>LLEGADAS</h6><div id="listIn"></div></div><div class="col-md-6"><h6>SALIDAS</h6><div id="listOut"></div></div></div></div></div>
            <div class="tab-pane fade" id="tab-caja"><div class="row g-4"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm mb-3"><h6 class="fw-bold mb-3 text-primary">Caja Chica</h6><select id="cajaTipo" class="form-select mb-2"><option value="egreso">üî¥ EGRESO</option><option value="ingreso">üü¢ INGRESO</option></select><select id="cajaCat" class="form-select mb-2"><option>Compras</option><option>Servicios</option><option>Otros</option></select><input type="text" id="cajaDesc" class="form-control mb-2" placeholder="Descripci√≥n"><input type="number" id="cajaMonto" class="form-control mb-2" placeholder="Monto"><button class="btn btn-dark w-100" onclick="window.funcs.guardarMovimientoCaja()">REGISTRAR</button></div><div class="card bg-warning bg-opacity-10 p-3 text-center"><h6 class="fw-bold">SALDO</h6><h2 class="fw-bold text-warning" id="cajaSaldo">S/ 0.00</h2></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-sm" id="tablaCaja"><thead class="table-light"><tr><th>Fecha</th><th>Tipo</th><th>Desc</th><th>Monto</th><th></th></tr></thead><tbody id="bodyCaja"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-inventario"><div class="row g-4"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm"><h6>Nuevo Item</h6><select id="invTipo" class="form-select mb-2" onchange="window.funcs.toggleStockInput()"><option value="producto">Producto</option><option value="servicio">Servicio</option></select><input type="text" id="invNombre" class="form-control mb-2" placeholder="Nombre"><input type="number" id="invPrecio" class="form-control mb-2" placeholder="Precio"><div id="divStockInput"><input type="number" id="invStock" class="form-control mb-2" placeholder="Stock"></div><button class="btn btn-success w-100" onclick="window.funcs.agregarProducto()">GUARDAR</button></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-sm"><thead class="table-light"><tr><th>Item</th><th>Tipo</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead><tbody id="tablaInventario"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-reporte"><div class="row g-3 mb-4"><div class="col-md-3"><div class="card p-3 border-0 shadow-sm"><label class="small fw-bold">Desde</label><input type="date" id="hist_desde" class="form-control" onchange="window.funcs.actualizarReporte()"></div></div><div class="col-md-3"><div class="card p-3 border-0 shadow-sm"><label class="small fw-bold">Hasta</label><input type="date" id="hist_hasta" class="form-control" onchange="window.funcs.actualizarReporte()"></div></div><div class="col-md-6 d-flex align-items-end"><button class="btn btn-success me-2" onclick="window.funcs.exportarExcel()">Excel</button></div></div><div class="row mb-4"><div class="col-md-3"><div class="card card-dash bg-success p-3 text-white"><div>INGRESOS</div><h3 id="dashCobrado">S/ 0.00</h3></div></div><div class="col-md-3"><div class="card card-dash bg-secondary p-3 text-white"><div>GASTOS</div><h3 id="dashGastos">S/ 0.00</h3></div></div><div class="col-md-3"><div class="card card-dash bg-primary p-3 text-white"><div>UTILIDAD</div><h3 id="dashUtilidad">S/ 0.00</h3></div></div><div class="col-md-3"><div class="card card-dash bg-danger p-3 text-white"><div>PENDIENTE</div><h3 id="dashPendiente">S/ 0.00</h3></div></div></div><div id="captureArea" class="card border-0 shadow-sm p-4"><div class="table-responsive"><table class="table table-hover small" id="tablaHistorialHTML"><thead class="table-dark"><tr><th>Hab</th><th>Pax</th><th>Nombre</th><th>In/Out</th><th>Total</th><th>Pagado</th><th>Cierre</th></tr></thead><tbody id="tablaHistorial"></tbody></table></div></div></div>
            <div class="tab-pane fade" id="tab-usuarios"><div class="row"><div class="col-md-4"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">Usuario</h6><input type="hidden" id="editUserIndex" value="-1"><label class="small">Usuario</label><input type="text" id="newUserName" class="form-control mb-2"><label class="small">Contrase√±a</label><input type="text" id="newUserPass" class="form-control mb-2"><label class="small fw-bold mt-2">M√≥dulos:</label><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-mapa"><label>Mapa</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-limpieza"><label>Limpieza</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-calendario" checked><label>Calendario</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-operaciones" checked><label>Operaciones</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-caja"><label>Caja</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-inventario"><label>Almac√©n</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-reporte"><label>Reportes</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-config"><label>Configuraci√≥n</label></div><div class="form-check"><input class="form-check-input mod-check" type="checkbox" value="nav-usuarios"><label>Admin</label></div><div class="d-flex gap-2 mt-3"><button class="btn btn-primary w-100" onclick="window.funcs.guardarUsuario()">Guardar</button><button class="btn btn-outline-secondary" onclick="window.funcs.limpiarFormUsuario()">Limpiar</button></div></div></div><div class="col-md-8"><div class="card p-4 border-0 shadow-sm"><table class="table table-hover table-sm small"><thead class="table-light"><tr><th>User</th><th>Pass</th><th>Permisos</th><th></th></tr></thead><tbody id="tablaUsuarios"></tbody></table></div></div></div></div>
            <div class="tab-pane fade" id="tab-auditoria"><div class="card p-4 border-0 shadow-sm"><div class="d-flex justify-content-between mb-3"><h6 class="fw-bold">Logs</h6><div class="d-flex gap-2"><select id="filterUser" class="form-select form-select-sm" onchange="window.funcs.renderLogs()"><option value="">Todos</option></select><input type="date" id="filterDateFrom" class="form-control form-control-sm" onchange="window.funcs.renderLogs()"><input type="date" id="filterDateTo" class="form-control form-control-sm" onchange="window.funcs.renderLogs()"><button class="btn btn-sm btn-secondary" onclick="window.funcs.imprimirLogs()">Imprimir</button></div></div><div class="table-responsive" id="printLogsArea"><table class="table table-striped table-sm log-table"><thead class="table-dark"><tr><th>Fecha</th><th>User</th><th>Acci√≥n</th><th>Detalle</th></tr></thead><tbody id="tablaLogs"></tbody></table></div></div></div>
            <div class="tab-pane fade" id="tab-config"><div class="alert alert-info"><b><i class="fas fa-cloud me-2"></i>Conectado a Firebase:</b> Los datos se guardan en Google Cloud en tiempo real.</div><div class="row g-4"><div class="col-md-5"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">üõ†Ô∏è Herramientas</h6><p class="small text-muted">El backup autom√°tico est√° activo en la nube.</p></div></div><div class="col-md-7"><div class="card p-4 border-0 shadow-sm"><h6 class="fw-bold mb-3">üè® Gesti√≥n de Habitaciones</h6><div class="input-group mb-3"><input type="number" id="confNum" class="form-control" placeholder="N¬∞ Hab"><input type="text" id="confPiso" class="form-control" placeholder="Piso/Sec"><button class="btn btn-dark" onclick="window.funcs.agregarHabitacion()">‚ûï Agregar</button></div><div class="table-responsive" style="max-height: 400px; overflow-y:auto;"><table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th>Hab</th><th>Piso</th><th>Acci√≥n</th></tr></thead><tbody id="bodyConfigHabs"></tbody></table></div></div></div></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoIngreso" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-primary text-white"><h5>Nuevo Check-In</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><div class="row g-0"><div class="col-md-7 p-4"><div class="row g-2 mb-3"><div class="col-4"><label class="small fw-bold">DNI</label><input id="dni" class="form-control form-control-sm"></div><div class="col-8"><label class="small fw-bold">Nombre</label><input id="cliente" class="form-control form-control-sm fw-bold"></div><div class="col-6"><label class="small fw-bold">Celular</label><input id="c_celular" class="form-control form-control-sm"></div><div class="col-6"><label class="small fw-bold">Pax</label><input type="number" id="numPersonas" class="form-control form-control-sm" value="1"></div></div><div class="row g-2"><div class="col-6"><label class="small fw-bold">Habitaci√≥n</label><select id="habSelect" class="form-select form-select-sm" onchange="window.funcs.checkTipoHab('mapa')"></select></div><div class="col-6"><label class="small fw-bold">Tipo</label><select id="tipoHab" class="form-select form-select-sm"></select></div><div class="col-6"><label class="small fw-bold">IN</label><input type="date" id="checkin" class="form-control form-control-sm"></div><div class="col-6"><label class="small fw-bold">OUT</label><input type="date" id="checkout" class="form-control form-control-sm"></div></div></div><div class="col-md-5 bg-light p-4 border-start"><div class="card mb-3"><div class="card-body p-3"><label class="small fw-bold">Total S/</label><input type="number" id="total" class="form-control mb-2 fw-bold" value="0"><select id="pagoEstado" class="form-select form-select-sm mb-2" onchange="window.funcs.toggleAdelanto()"><option value="Falta Pagar">üî¥ Falta</option><option value="Pagado">üü¢ Pagado</option><option value="Adelanto">üü† Adelanto</option></select><div id="divAdelanto" style="display:none"><input type="number" id="adelanto" class="form-control form-control-sm mb-2" placeholder="Monto"></div><select id="medioPago" class="form-select form-select-sm"><option>Efectivo</option><option>Yape</option><option>Plin</option><option>Tarjeta</option></select></div></div><button class="btn btn-primary w-100 fw-bold" onclick="window.funcs.guardarReserva()">CONFIRMAR</button></div></div></div></div></div></div>
<div class="modal fade" id="modalH" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content border-0 shadow-lg"><div id="mh" class="modal-header detail-header"><h5 id="mt" class="fw-bold m-0">Detalle</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0" id="mb"></div></div></div></div>
<div class="modal fade" id="modalResCal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow-lg"><div class="modal-header bg-primary text-white"><h5 class="fw-bold m-0">Reserva (Cal)</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="row g-2"><div class="col-12"><input type="text" id="c_cliente" class="form-control form-control-sm" placeholder="Nombre"></div><div class="col-6"><input type="text" id="c_dni" class="form-control form-control-sm" placeholder="DNI"></div><div class="col-6"><input type="text" id="c_celular_cal" class="form-control form-control-sm" placeholder="Celular"></div><div class="col-4"><input type="number" id="c_numPersonas" class="form-control form-control-sm" value="1"></div><div class="col-8"><select id="c_habSelect" class="form-select form-select-sm" onchange="window.funcs.checkTipoHab('cal')"></select></div><div class="col-6"><select id="c_tipoHab" class="form-select form-select-sm"></select></div><div class="col-6"><select id="c_medioPago" class="form-select form-select-sm"><option>Efectivo</option><option>Yape</option></select></div><div class="col-6"><input type="date" id="c_in" class="form-control form-control-sm"></div><div class="col-6"><input type="date" id="c_out" class="form-control form-control-sm"></div><div class="col-6"><input type="number" id="c_total" class="form-control form-control-sm" placeholder="Total"></div><div class="col-6"><select id="c_pagoEstado" class="form-select form-select-sm" onchange="window.funcs.toggleAdelantoCal()"><option value="Falta Pagar">Falta</option><option value="Pagado">Pagado</option><option value="Adelanto">Adelanto</option></select></div><div class="col-12" id="divAdelantoCal" style="display:none"><input type="number" id="c_adelanto" class="form-control form-control-sm" placeholder="Monto Adelanto"></div><div class="col-12 mt-3"><button class="btn btn-primary w-100" onclick="window.funcs.guardarReservaCal()">Guardar</button></div></div></div></div></div></div>

<script type="module">
    // --- INTEGRACI√ìN FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // üî¥ PEGA AQU√ç TU CONFIG DE FIREBASE (Obtenida en Paso 1) üî¥
    const firebaseConfig = {
  apiKey: "AIzaSyBL05JC0LZ9IWBA3fzf1MGMZxj2opbumhY",
  authDomain: "sumaj-system.firebaseapp.com",
  projectId: "sumaj-system",
  storageBucket: "sumaj-system.firebasestorage.app",
  messagingSenderId: "1010435012694",
  appId: "1:1010435012694:web:fa471c7231a6036c08e3f7"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const DB_DOC_REF = doc(db, "sumaj_app", "hotel_db");

    // Datos Locales
    let habs = [], ress = [], historial = [], inventario = [], caja = [], users = [], logs = [], limpieza = {};
    let currentUser = null, modalInstance = null, modalResCal = null, modalNuevoIngreso = null;
    let calDate = new Date();
    const { jsPDF } = window.jspdf;
    const now = new Date();
    const hoy = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

    // Datos por Defecto (Solo para primera vez)
    const defaultData = {
        habs: [
            {num:101, piso:'Piso 1'}, {num:102, piso:'Piso 1'}, {num:103, piso:'Piso 1'}, {num:104, piso:'Piso 1'}, {num:105, piso:'Piso 1'}, {num:106, piso:'Piso 1'}, {num:107, piso:'Piso 1'}, {num:108, piso:'Piso 1'},
            {num:201, piso:'Piso 2'}, {num:202, piso:'Piso 2'}, {num:203, piso:'Piso 2'}, {num:204, piso:'Piso 2'}, {num:205, piso:'Piso 2'}, {num:206, piso:'Piso 2'}, {num:207, piso:'Piso 2'}, {num:208, piso:'Piso 2'},
            {num:1, piso:'Departamento', tipo:'Familiar'}, {num:2, piso:'Departamento', tipo:'Matrimonial Vista'}, {num:3, piso:'Departamento', tipo:'Matrimonial'},
            {num:4, piso:'Muelle', tipo:'Matrimonial Muelle'}, {num:5, piso:'Muelle', tipo:'Matrimonial Muelle'}
        ],
        users: [{user: 'admin', pass: 'admin707', modules: ['all']}], // USUARIO POR DEFECTO
        ress: [], historial: [], inventario: [], caja: [], logs: [], limpieza: {}
    };

    // Sincronizaci√≥n
    async function saveData() {
        document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-sync fa-spin text-warning me-1"></i>Guardando...';
        try {
            await setDoc(DB_DOC_REF, { habs, ress, historial, inventario, caja, users, logs, limpieza });
            document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-check-circle text-success me-1"></i>En l√≠nea';
        } catch (e) {
            console.error(e);
            document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-exclamation-triangle text-danger me-1"></i>Error Red';
        }
    }

    onSnapshot(DB_DOC_REF, (doc) => {
        if (doc.exists()) {
            const d = doc.data();
            habs = d.habs; ress = d.ress; historial = d.historial; inventario = d.inventario; caja = d.caja; users = d.users; logs = d.logs; limpieza = d.limpieza;
            document.getElementById('cloudStatus').innerHTML = '<i class="fas fa-wifi text-success me-1"></i>Sincronizado';
            if(currentUser) { window.funcs.actualizarPantalla(); window.funcs.renderCal(); window.funcs.renderLimpieza(); }
        } else {
            // Primera vez: Crear DB
            setDoc(DB_DOC_REF, defaultData);
        }
    });

    // Funciones Globales
    window.funcs = {
        login: () => {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const usr = users.find(x => x.user === u && x.pass === p);
            if (usr) {
                currentUser = usr;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appInterface').style.display = 'block';
                document.getElementById('userDisplay').innerText = `üë§ ${currentUser.user.toUpperCase()}`;
                window.funcs.initSystem();
            } else { alert("Datos incorrectos"); }
        },
        logout: () => location.reload(),
        initSystem: () => {
            document.getElementById('checkin').value = hoy; document.getElementById('checkout').value = hoy;
            document.getElementById('filtroFecha').value = hoy; document.getElementById('fechaOp').value = hoy;
            calDate = new Date(); calDate.setDate(1); 
            window.funcs.actualizarPantalla(); window.funcs.renderConfigHabs(); window.funcs.renderCal();
            setInterval(()=>document.getElementById('reloj').innerText=new Date().toLocaleTimeString(),1000);
            
            // Event Listener Login Button Click
            document.getElementById('btnLogin').addEventListener('click', window.funcs.login);
        },
        
        // --- FUNCI√ìN DE CALENDARIO MEJORADA (Mitad Check-in / Mitad Check-out) ---
        renderCal: () => { 
            const t = document.getElementById('tablaCal'); 
            t.innerHTML = ''; 
            const y = calDate.getFullYear();
            const m = calDate.getMonth();
            const dias = new Date(y, m + 1, 0).getDate(); // D√≠as del mes actual
            
            const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
            document.getElementById('calMesTitulo').innerText = `${meses[m]} ${y}`;

            let h = '<thead><tr><th class="cal-room-col">HAB</th>'; 
            for(let i=1; i<=dias; i++){ 
                const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const esHoy = iso === hoy ? 'cal-today-col' : '';
                h += `<th class="${esHoy}">${i}</th>`; 
            } 
            h += '</tr></thead><tbody>'; 

            habs.forEach(hb => { 
                h += `<tr><td class="cal-room-col">${hb.piso.includes('Piso')?hb.num:hb.num}</td>`; 
                for(let i=1; i<=dias; i++){ 
                    const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    
                    const r = ress.find(x => x.habNum == hb.num && iso >= x.in && iso <= x.out);
                    const hist = historial.find(x => x.habNum == hb.num && iso >= x.in && iso <= x.out);

                    let bg = '';
                    let clickFn = '';

                    // L√ìGICA DE COLORES Y MITADES
                    if (hist && r && hist.out === iso && r.in === iso) {
                        bg = 'linear-gradient(to right, var(--historial) 50%, var(--ocupado) 50%)'; // Mixto
                        clickFn = `window.funcs.verDetalle(${hb.num}, ${r.id})`;
                    }
                    else if (r) {
                        clickFn = `window.funcs.verDetalle(${hb.num}, ${r.id})`;
                        if (r.in === iso && r.out === iso) bg = 'var(--ocupado)';
                        else if (r.in === iso) bg = 'linear-gradient(to right, #fff 50%, var(--ocupado) 50%)';
                        else if (r.out === iso) bg = 'linear-gradient(to right, var(--ocupado) 50%, #fff 50%)';
                        else bg = 'var(--ocupado)';
                    }
                    else if (hist) {
                        clickFn = `window.funcs.verDetalle(${hb.num}, ${hist.id}, true)`;
                        if (hist.in === iso && hist.out === iso) bg = 'var(--historial)';
                        else if (hist.in === iso) bg = 'linear-gradient(to right, #fff 50%, var(--historial) 50%)';
                        else if (hist.out === iso) bg = 'linear-gradient(to right, var(--historial) 50%, #fff 50%)';
                        else bg = 'var(--historial)';
                    }

                    h += `<td class="cal-cell" style="background:${bg}" onclick="${clickFn}"></td>`; 
                } 
                h += '</tr>'; 
            }); 
            t.innerHTML = h + '</tbody>'; 
        },

        // RESTO DE FUNCIONES
        abrirModalNuevaReserva: () => { if(!modalNuevoIngreso) modalNuevoIngreso = new bootstrap.Modal(document.getElementById('modalNuevoIngreso')); document.getElementById('cliente').value=''; document.getElementById('total').value='0'; document.getElementById('checkin').value=hoy; document.getElementById('checkout').value=hoy; window.funcs.checkTipoHab('mapa'); modalNuevoIngreso.show(); },
        checkTipoHab: (or) => { const hId=or==='mapa'?'habSelect':'c_habSelect', tId=or==='mapa'?'tipoHab':'c_tipoHab', sH=parseInt(document.getElementById(hId).value), sT=document.getElementById(tId), hObj=habs.find(h=>h.num===sH); if(hObj){ if(hObj.piso.includes('De')||hObj.piso.includes('Mu')){ sT.innerHTML=`<option>${hObj.tipo}</option>`; sT.disabled=true; }else{ sT.disabled=false; sT.innerHTML=`<option>Simple</option><option>Matrimonial</option><option>Doble</option><option>Triple</option>`; } } },
        guardarReserva: () => { const d=(id)=>document.getElementById(id).value; const t=parseFloat(d('total'))||0; if(!d('cliente'))return alert("Nombre?"); const sH=parseInt(d('habSelect')); let tip=d('tipoHab'); if(document.getElementById('tipoHab').disabled){const h=habs.find(x=>x.num===sH);if(h)tip=h.tipo;} ress.push({id:Date.now(),cliente:d('cliente'),dni:d('dni'),personas:d('numPersonas'),celular:d('c_celular'),habNum:sH,tipo:tip,in:d('checkin'),out:d('checkout'),total:t,adelanto:parseFloat(d('adelanto'))||0,medioPago:d('medioPago'),consumos:[]}); saveData(); modalNuevoIngreso.hide(); },
        actualizarPantalla: () => { const f=document.getElementById('filtroFecha').value, g=document.getElementById('gridHabitaciones'), s=document.getElementById('habSelect'), sc=document.getElementById('c_habSelect'); g.innerHTML=''; s.innerHTML=''; sc.innerHTML=''; const ps=[...new Set(habs.map(h=>h.piso))].sort(); ps.forEach(p=>{ g.innerHTML+=`<div class="col-12 piso-header mb-2">${p}</div>`; habs.filter(h=>h.piso===p).sort((a,b)=>a.num-b.num).forEach(h=>{ const r=ress.find(x=>x.habNum==h.num&&f>=x.in&&f<x.out); let cl='hab-card', st='<span class="badge bg-success">Libre</span>', inf='Disp'; if(r){ cl+=' status-ocupado'; st='<span class="badge bg-danger">Ocupado</span>'; inf=r.cliente; } else if(limpieza[h.num]=='sucia') { cl+=' status-sucia'; st='<span class="badge bg-warning text-dark">Sucia</span>'; inf='Sucia'; } g.innerHTML+=`<div class="col-xl-3 col-lg-3 col-md-4 col-6 mb-3"><div class="${cl} p-3" onclick="window.funcs.verDetalle(${h.num},${r?r.id:null})"><b>${h.num}</b> ${st}<br><small>${inf}</small></div></div>`; const o=`<option value="${h.num}">${h.num}</option>`; s.innerHTML+=o; sc.innerHTML+=o; }); }); window.funcs.checkTipoHab('mapa'); },
        verDetalle: (n,id, isH) => { if(!modalInstance)modalInstance=new bootstrap.Modal(document.getElementById('modalH')); let r; if(id) r = isH ? historial.find(x=>x.id==id) : ress.find(x=>x.id==id); else { const f=document.getElementById('filtroFecha').value; r=ress.find(x=>x.habNum==n&&(f>=x.in&&f<=x.out)); } if(!r){ const st=limpieza[n]||'limpia'; document.getElementById('mb').innerHTML=`<div class="p-5 text-center"><h5>${st.toUpperCase()}</h5><button class="btn btn-warning" onclick="window.funcs.setLim(${n},'sucia')">Sucia</button> <button class="btn btn-primary" onclick="window.funcs.setLim(${n},'limpia')">Limpia</button></div>`; modalInstance.show(); return; } const h=`<div class="row g-0"><div class="col-7 p-4 border-end"><h5>${r.cliente}</h5><p>${r.in} - ${r.out}</p></div><div class="col-5 p-4 bg-light"><h5>S/ ${r.total}</h5>${!isH ? `<button class="btn btn-dark w-100" onclick="window.funcs.checkOut(${r.id})">Salida</button>`:''}</div></div>`; document.getElementById('mb').innerHTML=h; modalInstance.show(); },
        setLim: (n,s) => { limpieza[n]=s; saveData(); window.funcs.verDetalle(n,null); },
        checkOut: (id) => { if(confirm("¬øSalida?")){ const r=ress.find(x=>x.id==id); r.outReal=new Date().toLocaleString(); historial.push(r); ress=ress.filter(x=>x.id!==id); limpieza[r.habNum]='sucia'; saveData(); modalInstance.hide(); } },
        navMes: (d) => { calDate.setMonth(calDate.getMonth()+d); calDate.setDate(1); window.funcs.renderCal(); },
        toggleAdelanto: () => { document.getElementById('divAdelanto').style.display=document.getElementById('pagoEstado').value==='Adelanto'?'block':'none'; },
        toggleAdelantoCal: () => { document.getElementById('divAdelantoCal').style.display=document.getElementById('c_pagoEstado').value==='Adelanto'?'block':'none'; },
        toggleStockInput: () => { const t=document.getElementById('invTipo').value;document.getElementById('divStockInput').style.display=t==='servicio'?'none':'block'; },
        guardarReservaCal: () => { /* Logica igual a guardarReserva pero con campos _c */ alert("Usar modal principal por ahora."); },
        exportarExcel: () => { alert("Exportando..."); },
        imprimirLogs: () => { window.print(); },
        renderLogs: () => { /* Render simple */ },
        renderUsuarios: () => { const t=document.getElementById('tablaUsuarios'); t.innerHTML=''; users.forEach(u=>t.innerHTML+=`<tr><td>${u.user}</td><td>***</td></tr>`); },
        guardarUsuario: () => { users.push({user:document.getElementById('newUserName').value, pass:document.getElementById('newUserPass').value, modules:['all']}); saveData(); window.funcs.renderUsuarios(); },
        limpiarFormUsuario: () => { document.getElementById('newUserName').value=''; },
        actualizarOperaciones: () => { /* ... */ },
        renderCaja: () => { /* ... */ },
        guardarMovimientoCaja: () => { /* ... */ },
        renderInventario: () => { /* ... */ },
        agregarProducto: () => { /* ... */ },
        actualizarReporte: () => { /* ... */ },
        renderConfigHabs: () => { /* ... */ },
        agregarHabitacion: () => { /* ... */ },
        exportarCalPDF: () => {}, exportarCalImg: () => {}
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA SUMAJ - v38.0 (STABLE FIX)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --primary: #0f4c75;       /* Azul Profundo */
            --secondary: #3282b8;     /* Azul Laguna */
            --accent: #bbe1fa;        /* Azul Claro */
            --bg-body: #f4f6f8;
            
            --disponible: #28a745; 
            --ocupado: #dc3545;       
            --salida: #fd7e14;        
            --sucia: #ffc107; 
            --limpieza: #17a2b8; 
            --mantenimiento: #6f42c1;
            --desactivado: #adb5bd;
        }

        body { 
            background-color: var(--bg-body); 
            font-family: 'Poppins', sans-serif; 
            color: #343a40;
            padding-bottom: 80px;
        }

        .swal2-container { z-index: 9999 !important; }

        /* --- UI COMPONENTS --- */
        .navbar { 
            background: linear-gradient(90deg, #1b262c 0%, #0f4c75 100%); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.5s ease;
        }
        
        .nav-pills .nav-link { 
            color: #495057; 
            font-weight: 600; 
            border-radius: 50px; 
            padding: 8px 20px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .nav-pills .nav-link.active { 
            background-color: var(--secondary); 
            color: white; 
            box-shadow: 0 4px 6px rgba(50, 130, 184, 0.3);
        }
        .nav-pills { overflow-x: auto; flex-wrap: nowrap; padding-bottom: 5px; }
        .nav-pills::-webkit-scrollbar { height: 4px; }
        .nav-pills::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

        /* --- ROOM CARDS --- */
        .hab-card { 
            border: none; border-radius: 16px; background: white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden; cursor: pointer; height: 100%;
        }
        .hab-card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.1); }
        .hab-card .card-top-strip { height: 6px; width: 100%; position: absolute; top: 0; left: 0; }
        .hab-number { font-size: 1.8rem; font-weight: 700; color: #2c3e50; line-height: 1; }
        .hab-type { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #888; font-weight: 600; }
        
        /* Status Borders & Chips */
        .b-disponible { background-color: var(--disponible); } .b-ocupado { background-color: var(--ocupado); }
        .b-salida { background-color: var(--salida); } .b-sucia { background-color: var(--sucia); }
        .b-limpieza { background-color: var(--limpieza); } .b-mantenimiento { background-color: var(--mantenimiento); }
        .status-chip { font-size: 0.7rem; padding: 4px 10px; border-radius: 12px; font-weight: 700; text-transform: uppercase; }
        .chip-libre { background: #d4edda; color: #155724; } .chip-ocupado { background: #f8d7da; color: #721c24; } .chip-salida { background: #fff3cd; color: #856404; }

        /* --- CALENDAR --- */
        .cal-wrapper { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .table-calendar { font-size: 0.8rem; width: 100%; min-width: 1000px; border-collapse: separate; border-spacing: 2px; }
        .table-calendar th { text-align: center; background: #212529 !important; color: #ffffff !important; padding: 10px 5px; border-radius: 4px; }
        .cal-room-col { background: #212529 !important; color: #ffffff !important; position: sticky; left: 0; z-index: 10; font-weight: bold; width: 100px; text-align: left !important; padding-left: 10px !important; border-right: 1px solid #444; }
        .cal-cell { height: 45px; border-radius: 4px; cursor: pointer; transition: 0.2s; background-color: #f8f9fa; border: 1px solid #e9ecef; }
        .cal-cell:hover { transform: scale(1.1); z-index: 20; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        .cal-today-col { border-bottom: 3px solid var(--sucia) !important; background-color: #2c3e50 !important; color: #ffc107 !important; }

        @media (max-width: 768px) {
            .table-calendar { font-size: 0.65rem; min-width: 800px; }
            .cal-room-col { width: 70px; padding-left: 5px !important; font-size: 0.7rem; }
            .cal-cell { height: 35px; min-width: 25px; }
            .hab-number { font-size: 1.4rem; }
            .modal-dialog { margin: 0.5rem; }
            #appInterface { padding-left: 0; padding-right: 0; }
        }

        /* --- LOGIN --- */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(15, 76, 117, 0.9), rgba(50, 130, 184, 0.9)), url('https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'); background-size: cover; background-position: center; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 3rem; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); width: 100%; max-width: 420px; text-align: center; position: relative; overflow: hidden; }
        .login-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--secondary), var(--primary)); }

        /* --- EXTRAS --- */
        .modal-content { border-radius: 16px; border: none; overflow: hidden; }
        .modal-header { background: #f8f9fa; border-bottom: 1px solid #eee; padding: 1.5rem; }
        .piso-divider { display: flex; align-items: center; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px; color: #adb5bd; margin: 2rem 0 1rem; font-weight: 700; }
        .piso-divider::after { content: ""; flex: 1; height: 1px; background: #e9ecef; margin-left: 1rem; }
        .op-card { border-left: 4px solid #ccc; background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center;}
        .op-in { border-color: var(--disponible); } .op-out { border-color: var(--ocupado); }
        .form-floating > .form-control:focus ~ label { color: var(--secondary); }
        .form-control:focus { border-color: var(--secondary); box-shadow: 0 0 0 0.25rem rgba(50, 130, 184, 0.25); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card animate__animated animate__fadeInUp">
        <div class="mb-4">
            <i class="fas fa-hotel fa-3x text-primary mb-3"></i>
            <h3 class="fw-bold text-dark">SUMAJ LODGE</h3>
            <p class="text-muted small">Sistema de Gesti贸n Hotelera v38.0</p>
        </div>
        <div class="form-floating mb-3 text-start">
            <input type="text" class="form-control" id="loginUser" placeholder="Usuario">
            <label for="loginUser">Usuario</label>
        </div>
        <div class="form-floating mb-4 text-start">
            <input type="password" class="form-control" id="loginPass" placeholder="Contrase帽a">
            <label for="loginPass">Contrase帽a</label>
        </div>
        <button class="btn btn-primary w-100 py-3 fw-bold rounded-pill shadow-lg" onclick="window.funcs.login()">
            INGRESAR AL SISTEMA
        </button>
        <div class="mt-4 text-muted small">漏 2026 Sumaj Lagoon Lodge</div>
    </div>
</div>

<div id="appInterface" style="display:none;">
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-water me-2"></i>SUMAJ <span class="fw-light">MANAGER</span>
                <span id="networkStatus" class="badge bg-success ms-2" style="font-size:0.6rem; vertical-align: middle;">ONLINE</span>
            </a>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end text-white d-none d-md-block">
                    <div id="userDisplay" class="fw-bold" style="font-size: 0.9rem;">Usuario</div>
                    <div id="reloj" class="small text-white-50" style="font-size: 0.75rem;">00:00:00</div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm rounded-circle" type="button" onclick="window.funcs.logout()">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-2 py-4">
        <ul class="nav nav-pills mb-4 gap-2 bg-white p-2 rounded-4 shadow-sm" id="mainTabs">
            <li class="nav-item" id="nav-mapa"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-mapa"><i class="fas fa-map me-2"></i>MAPA</button></li>
            <li class="nav-item" id="nav-limpieza"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-limpieza" onclick="window.funcs.renderLimpieza()"><i class="fas fa-broom me-2"></i>LIMPIEZA</button></li>
            <li class="nav-item" id="nav-calendario"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-calendario" onclick="window.funcs.renderCal()"><i class="far fa-calendar-alt me-2"></i>CALENDARIO</button></li>
            <li class="nav-item" id="nav-operaciones"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-operaciones" onclick="window.funcs.actualizarOperaciones()"><i class="fas fa-clipboard-list me-2"></i>OPERACIONES</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-caja" onclick="window.funcs.renderCaja()"><i class="fas fa-cash-register me-2"></i>CAJA</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-inventario"><i class="fas fa-boxes me-2"></i>ALMACN</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-usuarios" onclick="window.funcs.renderUsuarios()"><i class="fas fa-users-cog me-2"></i>USUARIOS</button></li>
            <li class="nav-item role-admin"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-auditoria" onclick="window.funcs.renderLogs()"><i class="fas fa-eye me-2"></i>LOGS</button></li>
            <li class="nav-item role-admin ms-auto"><button class="nav-link text-secondary" data-bs-toggle="tab" data-bs-target="#tab-config" onclick="window.funcs.renderConfigHabs()"><i class="fas fa-cog"></i></button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-mapa">
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm rounded-4 p-3 d-flex flex-row align-items-center justify-content-between flex-wrap gap-3">
                            <div class="d-flex align-items-center gap-2">
                                <span class="fw-bold text-muted small text-uppercase">Leyenda:</span>
                                <span class="badge bg-success rounded-pill fw-normal">Libre</span>
                                <span class="badge bg-danger rounded-pill fw-normal">Ocupado</span>
                                <span class="badge bg-warning text-dark rounded-pill fw-normal">Sucia</span>
                                <span class="badge rounded-pill fw-normal text-white" style="background-color: var(--salida);">Salida</span>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="date" id="filtroFecha" class="form-control form-control-sm rounded-pill border-0 bg-light fw-bold" style="width: 150px;" onchange="window.funcs.actualizarPantalla()">
                                <button class="btn btn-primary btn-sm rounded-pill px-3 fw-bold shadow-sm" onclick="window.funcs.abrirModalNuevaReserva()"><i class="fas fa-plus me-1"></i> NUEVA</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="gridHabitaciones" class="row g-3"></div>
            </div>
            
            <div class="tab-pane fade" id="tab-limpieza">
                <div class="card border-0 shadow rounded-4 overflow-hidden">
                    <div class="card-header bg-white p-4 border-bottom">
                        <h5 class="fw-bold m-0 text-primary"><i class="fas fa-broom me-2"></i>Gesti贸n de Housekeeping</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="row g-0">
                            <div class="col-md-6 p-4 border-end bg-light">
                                <h6 class="text-danger fw-bold mb-4 text-uppercase ls-1"><i class="fas fa-times-circle me-2"></i>Pendientes / Sucias</h6>
                                <div id="listSucias" class="d-flex flex-column gap-2"></div>
                            </div>
                            <div class="col-md-6 p-4">
                                <h6 class="text-success fw-bold mb-4 text-uppercase ls-1"><i class="fas fa-check-circle me-2"></i>Listas para Entrega</h6>
                                <div id="listLimpias" class="d-flex flex-column gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-calendario">
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-light rounded-circle shadow-sm" onclick="window.funcs.navMes(-1)"><i class="fas fa-chevron-left"></i></button>
                            <h5 class="m-0 fw-bold text-primary mx-3" id="calMesTitulo"></h5>
                            <button class="btn btn-light rounded-circle shadow-sm" onclick="window.funcs.navMes(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.funcs.exportarCalImg()"><i class="fas fa-image me-1"></i> PNG</button>
                            <button class="btn btn-outline-danger btn-sm" onclick="window.funcs.exportarCalPDF()"><i class="fas fa-file-pdf me-1"></i> PDF</button>
                        </div>
                    </div>
                    <div id="calContainer" class="cal-wrapper">
                        <table class="table-calendar" id="tablaCal"></table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-caja">
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm rounded-4 mb-3 bg-primary text-white">
                            <div class="card-body text-center p-4">
                                <div class="small text-white-50 text-uppercase fw-bold mb-1">Saldo Actual</div>
                                <h1 class="display-5 fw-bold mb-0" id="cajaSaldo">S/ 0.00</h1>
                            </div>
                        </div>
                        <div class="card border-0 shadow-sm rounded-4 p-4">
                            <h6 class="fw-bold mb-3 text-secondary">Registrar Movimiento</h6>
                            <div class="form-floating mb-2">
                                <select id="cajaTipo" class="form-select border-0 bg-light fw-bold"><option value="egreso"> EGRESO (Gasto)</option><option value="ingreso"> INGRESO (Extra)</option></select>
                                <label>Tipo de Movimiento</label>
                            </div>
                            <div class="form-floating mb-2">
                                <select id="cajaCat" class="form-select border-0 bg-light"><option>Compras Insumos</option><option>Servicios B谩sicos</option><option>Mantenimiento</option><option>Ventas Extra</option><option>Otros</option></select>
                                <label>Categor铆a</label>
                            </div>
                            <div class="form-floating mb-2">
                                <input type="text" id="cajaDesc" class="form-control border-0 bg-light" placeholder="Desc">
                                <label>Descripci贸n</label>
                            </div>
                            <div class="form-floating mb-3">
                                <input type="number" id="cajaMonto" class="form-control border-0 bg-light fw-bold" placeholder="0.00">
                                <label>Monto (S/)</label>
                            </div>
                            <button class="btn btn-dark w-100 rounded-pill py-2 shadow" onclick="window.funcs.guardarMovimientoCaja()">GUARDAR</button>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm rounded-4 p-0 overflow-hidden">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0" id="tablaCaja">
                                    <thead class="bg-light small text-muted text-uppercase"><tr><th class="ps-4">Fecha</th><th>Tipo</th><th>Cat</th><th>Desc</th><th>Monto</th><th></th></tr></thead>
                                    <tbody id="bodyCaja" class="border-top-0"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-operaciones">
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <div class="d-flex justify-content-between mb-4">
                        <h5 class="fw-bold">Reporte Operativo Diario</h5>
                        <input type="date" id="fechaOp" class="form-control w-auto rounded-pill" onchange="window.funcs.actualizarOperaciones()">
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded-4 h-100">
                                <h6 class="fw-bold text-success mb-3"><i class="fas fa-plane-arrival me-2"></i>LLEGADAS (Check-In)</h6>
                                <div id="listIn"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="p-3 bg-light rounded-4 h-100">
                                <h6 class="fw-bold text-danger mb-3"><i class="fas fa-plane-departure me-2"></i>SALIDAS (Check-Out)</h6>
                                <div id="listOut"></div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-inventario">
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm rounded-4 p-4">
                            <h6 class="fw-bold mb-3">Nuevo Item / Servicio</h6>
                            <input type="text" id="invNombre" class="form-control mb-2 bg-light border-0" placeholder="Nombre del Item">
                            <div class="row g-2 mb-2">
                                <div class="col-6"><select id="invTipo" class="form-select bg-light border-0" onchange="window.funcs.toggleStockInput()"><option value="producto">Producto</option><option value="servicio">Servicio</option></select></div>
                                <div class="col-6"><input type="number" id="invPrecio" class="form-control bg-light border-0" placeholder="Precio S/"></div>
                            </div>
                            <div id="divStockInput"><input type="number" id="invStock" class="form-control mb-3 bg-light border-0" placeholder="Stock Inicial"></div>
                            <button class="btn btn-success w-100 rounded-pill" onclick="window.funcs.agregarProducto()">AGREGAR</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                         <div class="card border-0 shadow-sm rounded-4 overflow-hidden"><table class="table table-hover mb-0"><thead class="bg-light"><tr><th class="ps-4">Item</th><th>Tipo</th><th>Precio</th><th>Stock</th><th></th></tr></thead><tbody id="tablaInventario"></tbody></table></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="tab-usuarios">
                 <div class="row">
                    <div class="col-md-4">
                        <div class="card p-4 border-0 shadow-sm rounded-4">
                            <h6 class="fw-bold mb-3">Gesti贸n Usuario</h6>
                            <input type="hidden" id="editUserIndex" value="-1">
                            <input type="text" id="newUserName" class="form-control mb-2 bg-light border-0" placeholder="Usuario">
                            <input type="text" id="newUserPass" class="form-control mb-2 bg-light border-0" placeholder="Contrase帽a">
                            <div class="permiso-grid mb-3 small text-muted">Seleccione permisos abajo...</div>
                            <div class="permiso-grid mb-3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-mapa" id="p_mapa"><label class="form-check-label small" for="p_mapa">Mapa</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-limpieza" id="p_limp"><label class="form-check-label small" for="p_limp">Limpieza</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-calendario" id="p_cal"><label class="form-check-label small" for="p_cal">Calendario</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-operaciones" id="p_ops"><label class="form-check-label small" for="p_ops">Operaciones</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-caja" id="p_caja"><label class="form-check-label small" for="p_caja">Caja</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-inventario" id="p_inv"><label class="form-check-label small" for="p_inv">Almac茅n</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-usuarios" id="p_usu"><label class="form-check-label small" for="p_usu">Usuarios</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-auditoria" id="p_aud"><label class="form-check-label small" for="p_aud">Auditor铆a</label></div>
                                <div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="nav-config" id="p_conf"><label class="form-check-label small" for="p_conf">Config</label></div>
                            </div>
                            <div class="d-flex gap-2"><button class="btn btn-primary w-100 rounded-pill" onclick="window.funcs.guardarUsuario()">Guardar</button><button class="btn btn-outline-secondary rounded-pill" onclick="window.funcs.limpiarFormUsuario()">X</button></div>
                        </div>
                    </div>
                    <div class="col-md-8"><div class="card border-0 shadow-sm rounded-4 overflow-hidden"><table class="table table-hover mb-0"><thead class="bg-light"><tr><th class="ps-4">User</th><th>M贸dulos</th><th>Acci贸n</th></tr></thead><tbody id="tablaUsuarios"></tbody></table></div></div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-auditoria">
                 <div class="card border-0 shadow-sm rounded-4 p-3">
                     <div class="d-flex gap-2 mb-3 bg-light p-2 rounded align-items-end">
                         <div><label class="small fw-bold">Usuario</label><select id="filterLogUser" class="form-select form-select-sm border-0"><option value="">Todos</option></select></div>
                         <div><label class="small fw-bold">Desde</label><input type="date" id="filterLogStart" class="form-control form-control-sm border-0"></div>
                         <div><button class="btn btn-sm btn-dark px-3" onclick="window.funcs.renderLogs()">Filtrar</button></div>
                     </div>
                     <div class="table-responsive" id="printLogsArea"><table class="table table-sm table-striped small"><thead class="table-dark"><tr><th>Fecha</th><th>User</th><th>Acci贸n</th><th>Detalle</th></tr></thead><tbody id="tablaLogs"></tbody></table></div>
                 </div>
            </div>
            
            <div class="tab-pane fade" id="tab-config">
                 <div class="row g-4">
                     <div class="col-md-4"><div class="card border-0 shadow-sm rounded-4 p-4"><h6 class="fw-bold">Respaldo Local</h6><button class="btn btn-outline-primary w-100" onclick="window.funcs.descargarBackup()">Descargar JSON</button></div></div>
                     <div class="col-md-8"><div class="card border-0 shadow-sm rounded-4 p-4"><h6 class="fw-bold">Habitaciones</h6><div class="input-group mb-3"><input id="confNum" class="form-control" placeholder="Num"><input id="confPiso" class="form-control" placeholder="Piso"><button class="btn btn-dark" onclick="window.funcs.agregarHabitacion()">+</button></div><div style="max-height:300px;overflow-y:auto"><table class="table table-sm"><tbody id="bodyConfigHabs"></tbody></table></div></div></div>
                 </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoIngreso" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="fw-bold m-0"><i class="fas fa-concierge-bell me-2"></i>Check-In</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-md-7 p-4">
                         <h6 class="text-primary fw-bold mb-2 small text-uppercase ls-1">Fechas de Estancia</h6>
                         <div class="row g-2 mb-3 bg-light p-2 rounded">
                            <div class="col-6"><div class="form-floating"><input type="date" id="checkin" class="form-control bg-white border-0 fw-bold" onchange="window.funcs.cargarHabitacionesDisponibles()"><label>Entrada</label></div></div>
                            <div class="col-6"><div class="form-floating"><input type="date" id="checkout" class="form-control bg-white border-0 fw-bold" onchange="window.funcs.cargarHabitacionesDisponibles()"><label>Salida</label></div></div>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-md-4"><div class="form-floating"><input type="text" id="dni" class="form-control bg-light border-0" placeholder="DNI" onkeyup="window.funcs.buscarCliente(this.value)"><label>DNI / DOC</label></div></div>
                            <div class="col-md-8"><div class="form-floating"><input type="text" id="cliente" class="form-control fw-bold border-0" placeholder="Nombre"><label>Nombre Completo</label></div></div>
                            <div class="col-md-6"><div class="form-floating"><input type="text" id="c_celular" class="form-control bg-light border-0" placeholder="Celular"><label>Celular</label></div></div>
                            <div class="col-md-6"><div class="form-floating"><input type="number" id="numPersonas" class="form-control bg-light border-0" value="1"><label>Personas</label></div></div>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-6"><div class="form-floating"><select id="habSelect" class="form-select border-primary fw-bold" onchange="window.funcs.checkTipoHab('mapa')"></select><label>Habitaci贸n (Libres)</label></div></div>
                            <div class="col-6"><div class="form-floating"><select id="tipoHab" class="form-select bg-light border-0"></select><label>Tipo</label></div></div>
                        </div>
                    </div>
                    <div class="col-md-5 bg-light p-4 d-flex flex-column justify-content-between border-start">
                        <div class="card border-0 shadow-sm p-3 mb-3">
                            <label class="small text-muted fw-bold mb-1">MONTO TOTAL</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-white border-end-0 fw-bold text-success">S/</span>
                                <input type="number" id="total" class="form-control border-start-0 fs-3 fw-bold text-dark p-0" value="0">
                            </div>
                            <div class="mb-2">
                                <label class="small text-muted fw-bold">Condici贸n</label>
                                <select id="pagoEstado" class="form-select form-select-sm fw-bold border-0 bg-secondary-subtle" onchange="window.funcs.toggleAdelanto()">
                                    <option value="Falta Pagar" class="text-danger"> Pendiente</option>
                                    <option value="Pagado" class="text-success"> Pagado</option>
                                    <option value="Adelanto" class="text-warning"> Adelanto</option>
                                </select>
                            </div>
                            <div id="divAdelanto" style="display:none;" class="animate__animated animate__fadeIn">
                                <label class="small fw-bold">Monto Adelantado</label>
                                <input type="number" id="adelanto" class="form-control fw-bold border-warning bg-warning bg-opacity-10" value="0">
                            </div>
                            <div class="mt-2">
                                <label class="small text-muted fw-bold">M茅todo</label>
                                <select id="medioPago" class="form-select form-select-sm bg-light border-0"><option>Efectivo</option><option>Yape/Plin</option><option>Tarjeta</option><option>Transf.</option></select>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100 py-3 fw-bold shadow hover-effect rounded-pill" onclick="window.funcs.guardarReserva()">
                            <i class="fas fa-check me-2"></i> CONFIRMAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalH" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg">
            <div id="mh" class="modal-header">
                <h5 id="mt" class="fw-bold m-0 text-dark">Detalle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="mb"></div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, doc, onSnapshot, setDoc, collection, addDoc, query, where, getDocs, orderBy, limit, 
        enableIndexedDbPersistence 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CREDENCIALES ---
    const firebaseConfig = {
        apiKey: "AIzaSyBL05JC0LZ9IWBA3fzf1MGMZxj2opbumhY",
        authDomain: "sumaj-system.firebaseapp.com",
        projectId: "sumaj-system",
        storageBucket: "sumaj-system.firebasestorage.app",
        messagingSenderId: "1010435012694",
        appId: "1:1010435012694:web:fa471c7231a6036c08e3f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Persistencia Offline (Mejorada con manejo de errores silencioso)
    enableIndexedDbPersistence(db).catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn('Persistencia fall贸: Multiples pesta帽as abiertas.');
        } else if (err.code == 'unimplemented') {
            console.warn('El navegador no soporta persistencia.');
        }
    });

    const DOC_ACTIVE = doc(db, "sumaj_data", "hotel_active");
    const COL_HISTORY = collection(db, "sumaj_data", "hotel_active", "historial_collection"); 
    const COL_LOGS = collection(db, "sumaj_data", "hotel_active", "logs_collection");

    // --- VARIABLES DE ESTADO ---
    // Definici贸n robusta de habitaciones por defecto
    const defaultHabs = [
        {num:101, piso:'Piso 1', tipo:'Matrimonial', active:true}, {num:102, piso:'Piso 1', tipo:'Matrimonial', active:true},
        {num:103, piso:'Piso 1', tipo:'Doble', active:true}, {num:104, piso:'Piso 1', tipo:'Matrimonial', active:true},
        {num:105, piso:'Piso 1', tipo:'Triple', active:true}, {num:106, piso:'Piso 1', tipo:'Matrimonial', active:true},
        {num:107, piso:'Piso 1', tipo:'Doble', active:true}, {num:108, piso:'Piso 1', tipo:'Familiar', active:true},
        {num:201, piso:'Piso 2', tipo:'Matrimonial', active:true}, {num:202, piso:'Piso 2', tipo:'Matrimonial', active:true},
        {num:203, piso:'Piso 2', tipo:'Doble', active:true}, {num:204, piso:'Piso 2', tipo:'Matrimonial', active:true},
        {num:205, piso:'Piso 2', tipo:'Triple', active:true}, {num:206, piso:'Piso 2', tipo:'Matrimonial', active:true},
        {num:207, piso:'Piso 2', tipo:'Doble', active:true}, {num:208, piso:'Piso 2', tipo:'Familiar', active:true},
        {num:301, piso:'Departamentos', tipo:'Departamento 1', active:true}, {num:302, piso:'Departamentos', tipo:'Departamento 2', active:true},
        {num:401, piso:'Zona Muelle', tipo:'Muelle', active:true}
    ];

    let habs = defaultHabs; let ress = []; let inventario = []; let caja = []; 
    let users = [{ user: 'admin', pass: 'admin707', role: 'admin', modules: ['all'] }]; 
    let limpieza = {}; let historialCache = []; 
    let currentUser = null; let modalInstance = null; let modalNuevoIngreso = null; 
    let calDate = new Date(); 
    
    // Fechas Locales
    const now = new Date(); 
    const offset = now.getTimezoneOffset() * 60000; 
    const localDate = new Date(now.getTime() - offset); 
    const hoy = localDate.toISOString().split('T')[0];
    const { jsPDF } = window.jspdf;

    // --- DETECTOR ONLINE/OFFLINE ---
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    function updateOnlineStatus() {
        const badge = document.getElementById('networkStatus');
        const nav = document.querySelector('.navbar');
        if (navigator.onLine) {
            badge.className = 'badge bg-success ms-2'; badge.innerText = 'ONLINE';
            if(nav) nav.style.background = 'linear-gradient(90deg, #1b262c 0%, #0f4c75 100%)';
        } else {
            badge.className = 'badge bg-danger ms-2'; badge.innerText = 'OFFLINE';
            if(nav) nav.style.background = 'linear-gradient(90deg, #5c2525 0%, #3e1212 100%)';
        }
    }

    async function saveActiveData() {
        try { 
            // Validar datos antes de guardar para evitar corrupciones
            const safeRess = ress.map(r => ({...r, id: String(r.id)})); // Forzar IDs a string
            await setDoc(DOC_ACTIVE, { habs, ress: safeRess, inventario, caja, users, limpieza, lastUpdate: new Date().toISOString() }); 
        } catch (e) { 
            console.error("Error guardando:", e); 
            Swal.fire({toast:true, position:'bottom-end', icon:'error', title:'Error de Sincronizaci贸n', timer:3000});
        }
    }

    function initRealtimeListener() {
        onSnapshot(DOC_ACTIVE, (docSnap) => {
            if (docSnap.exists()) {
                const d = docSnap.data();
                habs = d.habs && d.habs.length > 5 ? d.habs : defaultHabs; 
                // Asegurar compatibilidad de IDs
                ress = (d.ress || []).map(r => ({...r, id: String(r.id)})); 
                inventario = d.inventario || []; caja = d.caja || []; users = d.users || users; limpieza = d.limpieza || {};
                
                habs.forEach(h => { if(h.active === undefined) h.active = true; });

                if (!currentUser) {
                    const sessionUser = localStorage.getItem('sumaj_session');
                    if (sessionUser) {
                        const found = users.find(u => u.user === sessionUser);
                        if (found) {
                            currentUser = found;
                            document.getElementById('loginOverlay').style.display = 'none';
                            document.getElementById('appInterface').style.display = 'block';
                            document.getElementById('userDisplay').innerHTML = `<span class="fw-light">Hola,</span> ${currentUser.user.toUpperCase()}`;
                            funcs.aplicarPermisos(); funcs.initSystem();
                        }
                    }
                }
                if(currentUser) { 
                    funcs.actualizarPantalla(); funcs.renderCal(); funcs.renderLimpieza(); 
                    if(document.getElementById('tab-caja').classList.contains('active')) funcs.renderCaja(); 
                    funcs.populateLogUsers(); 
                }
            } else { saveActiveData(); }
        }, (error) => {
            console.error("Error Listener:", error);
        });
    }

    const funcs = {
        login: () => {
            const u = document.getElementById('loginUser').value; const p = document.getElementById('loginPass').value;
            const userFound = users.find(x => x.user === u && x.pass === p);
            if (userFound) {
                currentUser = userFound; localStorage.setItem('sumaj_session', userFound.user);
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appInterface').style.display = 'block';
                document.getElementById('userDisplay').innerHTML = `<span class="fw-light">Hola,</span> ${currentUser.user.toUpperCase()}`;
                funcs.aplicarPermisos(); funcs.registrarLog("LOGIN", "Ingreso al sistema"); funcs.initSystem();
            } else { Swal.fire({icon: 'error', title: 'Credenciales Incorrectas', showConfirmButton: false, timer: 1500}); }
        },
        logout: () => { localStorage.removeItem('sumaj_session'); location.reload(); },
        
        aplicarPermisos: () => {
            document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'none');
            const myMods = currentUser.modules || [];
            let firstTab = null;
            if (myMods.includes('all')) {
                document.querySelectorAll('.nav-item').forEach(el => el.style.display = 'block'); firstTab = '#tab-mapa';
            } else {
                myMods.forEach(modId => { const el = document.getElementById(modId); if(el) { el.style.display = 'block'; if(!firstTab) firstTab = el.querySelector('button').getAttribute('data-bs-target'); } });
            }
            if(firstTab) { const triggerEl = document.querySelector(`button[data-bs-target="${firstTab}"]`); if(triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show(); }
        },

        initSystem: () => {
            document.getElementById('checkin').value = hoy; document.getElementById('checkout').value = hoy; document.getElementById('filtroFecha').value = hoy; document.getElementById('fechaOp').value = hoy;
            calDate = new Date(); calDate.setDate(1); funcs.actualizarPantalla(); funcs.renderConfigHabs(); funcs.renderCal(); 
            if(funcs.checkPermiso('nav-caja')) funcs.renderCaja(); if(funcs.checkPermiso('nav-inventario')) funcs.renderInventario();
            if(funcs.checkPermiso('nav-usuarios')) funcs.renderUsuarios(); 
            funcs.renderLimpieza(); funcs.populateLogUsers();
            updateOnlineStatus();
            setInterval(()=>document.getElementById('reloj').innerText=new Date().toLocaleString(),1000);
        },

        // --- CORE UI ---
        actualizarPantalla: () => {
            const f = document.getElementById('filtroFecha').value; const grid = document.getElementById('gridHabitaciones'); 
            grid.innerHTML = ''; 
            const pisos = [...new Set(habs.map(h => h.piso))].sort();
            
            pisos.forEach(p => { 
                const label = String(p).includes('Piso') ? p : `${p.toUpperCase()}`; 
                const groupHabs = habs.filter(h => h.piso === p).sort((a,b)=>a.num-b.num);
                let contentHTML = '';
                
                groupHabs.forEach(h => {
                    if(h.active === false) return;
                    const r = ress.find(x => x.habNum == h.num && (f >= x.in && f <= x.out)); const stL = limpieza[h.num] || 'limpia'; 
                    
                    let statusClass = 'b-disponible';
                    let chip = '<span class="status-chip chip-libre">Libre</span>';
                    let mainInfo = '<div class="text-muted small">Disponible</div>';
                    let iconLimp = (stL === 'sucia') ? '<i class="fas fa-broom text-warning" title="Limpieza Requerida"></i>' : (stL === 'limpieza' ? '<i class="fas fa-pump-soap text-primary fa-spin"></i>' : '<i class="fas fa-check text-muted opacity-25"></i>');
                    
                    if (r) { 
                        const tC = (r.consumos||[]).reduce((a,b)=>a+(b.precio*b.cantidad),0), deu = (r.total + tC) - r.adelanto; 
                        if (f === r.out) { 
                            statusClass = 'b-salida'; chip = '<span class="status-chip chip-salida">Salida Hoy</span>'; 
                            mainInfo = `<div class="fw-bold text-dark text-truncate"><i class="fas fa-user-clock me-1"></i>${r.cliente}</div>`; 
                        } else { 
                            statusClass = 'b-ocupado'; chip = '<span class="status-chip chip-ocupado">Ocupado</span>'; 
                            mainInfo = `<div class="fw-bold text-primary text-truncate"><i class="fas fa-user me-1"></i>${r.cliente}</div>${deu > 0.1 ? `<small class="text-danger fw-bold">Deuda: S/ ${deu.toFixed(2)}</small>` : `<small class="text-success fw-bold"><i class="fas fa-check-double"></i> Pagado</small>`}`; 
                        } 
                    } else if (stL === 'sucia') { statusClass = 'b-sucia'; chip = '<span class="badge bg-warning text-dark">Sucia</span>'; mainInfo = '<div class="text-warning fw-bold">Limpieza Pendiente</div>'; } 
                    else if (stL === 'limpieza') { statusClass = 'b-limpieza'; chip = '<span class="badge bg-info">Limpiando</span>'; mainInfo = '<div class="text-info fw-bold">En Proceso...</div>'; }
                    else if (stL === 'mantenimiento') { statusClass = 'b-mantenimiento'; chip = '<span class="badge bg-secondary">Mant.</span>'; mainInfo = '<div class="text-muted">Mantenimiento</div>'; }

                    const dN = h.num > 400 ? 'Muelle' : (h.num > 300 ? 'Dept' : h.num);
                    const safeId = r ? `'${r.id}'` : null; // Importante: Comillas para el string en HTML
                    
                    contentHTML += `
                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                        <div class="hab-card" onclick="window.funcs.verDetalle(${h.num}, ${safeId})">
                            <div class="card-top-strip ${statusClass}"></div>
                            <div class="card-body p-3 d-flex flex-column h-100 justify-content-between">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="hab-number">${dN}</div>
                                    ${chip}
                                </div>
                                <div class="mb-2">
                                    <div class="hab-type mb-1">${h.tipo || 'Est谩ndar'}</div>
                                    ${mainInfo}
                                </div>
                                <div class="d-flex justify-content-end mt-2 border-top pt-2">
                                    ${iconLimp}
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                
                if(contentHTML) grid.innerHTML += `<div class="col-12"><div class="piso-divider">${label}</div></div>` + contentHTML;
            });
            funcs.checkTipoHab('mapa');
        },

        // --- DETALLE & MODALES ---
        verDetalle: (num, id, isH) => {
            const modalEl = document.getElementById('modalH');
            if (!modalInstance) {
                modalInstance = new bootstrap.Modal(modalEl);
            }

            let r;
            if (id) {
                const searchId = String(id);
                r = isH ? historialCache.find(x => String(x.id) === searchId) : ress.find(x => String(x.id) === searchId);
            } else {
                const f = document.getElementById('filtroFecha').value;
                r = ress.find(x => x.habNum == num && (f >= x.in && f <= x.out));
            }

            // SIN RESERVA
            if (!r) {
                const st = limpieza[num] || 'limpia';
                let actionArea = '';
                if (st === 'sucia') actionArea = `<button class="btn btn-primary w-100 mb-2 py-3 shadow" onclick="window.funcs.setEstadoLimpieza(${num},'limpieza')"><i class="fas fa-broom me-2"></i>Empezar Limpieza</button><button class="btn btn-outline-secondary w-100" onclick="window.funcs.setEstadoLimpieza(${num}, 'mantenimiento')">Mantenimiento</button>`;
                else if (st === 'limpieza') actionArea = `<button class="btn btn-success w-100 mb-2 py-3 shadow" onclick="window.funcs.setEstadoLimpieza(${num},'limpia')"><i class="fas fa-check me-2"></i>Terminar Limpieza</button>`;
                else if (st === 'mantenimiento') actionArea = `<button class="btn btn-success w-100 mb-2" onclick="window.funcs.setEstadoLimpieza(${num},'sucia')">Finalizar Mantenimiento</button>`;
                else actionArea = `<button class="btn btn-warning w-100 mb-2" onclick="window.funcs.setEstadoLimpieza(${num},'sucia')">Marcar Sucia</button><button class="btn btn-dark w-100 py-3 mt-3 shadow fw-bold" onclick="window.funcs.cerrarYReservar(${num})"><i class="fas fa-plus-circle me-2"></i>CREAR RESERVA</button>`;

                const statusColor = st === 'limpia' ? 'text-success' : (st === 'sucia' ? 'text-warning' : 'text-primary');
                const statusIcon = st === 'limpia' ? 'fa-check-circle' : (st === 'sucia' ? 'fa-broom' : 'fa-tools');
                const roomName = num > 400 ? 'Muelle' : (num > 300 ? 'Depto' : `Hab ${num}`);

                document.getElementById('mt').innerHTML = `${roomName}`;
                document.getElementById('mb').innerHTML = `<div class="text-center py-5 px-4"><i class="fas ${statusIcon} fa-4x ${statusColor} mb-3 animate__animated animate__pulse animate__infinite"></i><h4 class="fw-bold text-uppercase mb-4">${st}</h4><div class="d-grid gap-2 col-8 mx-auto">${actionArea}</div></div>`;
                modalInstance.show();
                return;
            }

            // CON RESERVA
            const cons = r.consumos || [];
            const tCons = cons.reduce((a, b) => a + (b.precio * b.cantidad), 0);
            const granT = isH ? r.totalFinal : (r.total + tCons);
            const deu = isH ? 0 : (granT - r.adelanto);
            const hBtn = isH ? 'display:none' : '';
            const safeId = `'${r.id}'`; // Importante: Comillas para onclick

            let ops = '<option value="">+ Agregar Item</option>';
            inventario.forEach(p => ops += `<option value="${p.id}">${p.nombre} - S/${p.precio}</option>`);

            const roomName = num > 400 ? 'Muelle' : (num > 300 ? 'Depto' : `Hab ${num}`);
            document.getElementById('mt').innerHTML = `<div class="d-flex align-items-center justify-content-between w-100"><span class="fw-bold fs-5">${roomName}</span> <span class="badge ${deu < 0.1 ? 'bg-success' : 'bg-danger'} rounded-pill">${deu < 0.1 ? 'PAGADO' : 'DEUDA'}</span></div>`;

            let html = `
            <div class="row g-0">
                <div class="col-lg-7 p-4 border-end">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div><h5 class="fw-bold m-0 text-primary">${r.cliente}</h5><div class="small text-muted"><i class="fas fa-id-card me-1"></i>${r.dni||'S/D'}</div></div>
                        ${!isH ? `<button class="btn btn-sm btn-light border" onclick="window.funcs.editarReserva(${safeId})"><i class="fas fa-pen text-secondary"></i></button>` : ''}
                    </div>
                    <div class="d-flex gap-2 mb-4">
                        <div class="bg-light p-2 rounded flex-fill text-center"><small class="d-block text-muted">ENTRADA</small><b>${r.in}</b></div>
                        <div class="bg-light p-2 rounded flex-fill text-center"><small class="d-block text-muted">SALIDA</small><b>${r.out}</b></div>
                        <div class="bg-light p-2 rounded flex-fill text-center"><small class="d-block text-muted">PAX</small><b>${r.personas}</b></div>
                    </div>
                    <h6 class="fw-bold border-bottom pb-2 mb-3">Consumos / Servicios</h6>
                    <div class="input-group input-group-sm mb-3" style="${hBtn}"><select id="selP" class="form-select">${ops}</select><input id="selQ" type="number" value="1" class="form-control" style="max-width:60px"><button class="btn btn-primary" onclick="window.funcs.addCons(${safeId})"><i class="fas fa-plus"></i></button></div>
                    <div class="table-responsive rounded border" style="max-height:200px;"><table class="table table-sm table-striped m-0 small align-middle"><tbody>${cons.length > 0 ? cons.map((c,i) => `<tr><td class="text-center fw-bold" width="30">${c.cantidad}</td><td>${c.item}</td><td class="text-end fw-bold">S/ ${(c.precio*c.cantidad).toFixed(2)}</td><td class="text-center" style="${hBtn}" width="30"><i class="fas fa-times text-danger cursor-pointer" onclick="window.funcs.delCons(${safeId},${i})"></i></td></tr>`).join('') : '<tr><td colspan="4" class="text-center text-muted py-3">Sin consumos registrados</td></tr>'}</tbody></table></div>
                </div>
                <div class="col-lg-5 p-4 bg-light d-flex flex-column">
                    <h6 class="fw-bold text-dark mb-3">Resumen de Cuenta</h6>
                    <div class="bg-white p-3 rounded shadow-sm mb-3">
                        <div class="d-flex justify-content-between mb-1 small"><span class="text-muted">Alojamiento</span><span>S/ ${r.total.toFixed(2)}</span></div>
                        <div class="d-flex justify-content-between mb-1 small"><span class="text-muted">Consumos</span><span>S/ ${tCons.toFixed(2)}</span></div>
                        <div class="d-flex justify-content-between border-top pt-2 mt-2 fw-bold fs-5"><span>TOTAL</span><span>S/ ${granT.toFixed(2)}</span></div>
                        <div class="d-flex justify-content-between text-success small fw-bold"><span>Pagado/Adelanto</span><span>- S/ ${r.adelanto.toFixed(2)}</span></div>
                        <div class="d-flex justify-content-between align-items-center mt-2 pt-2 border-top">
                            <span class="fw-bold text-danger">PENDIENTE:</span>
                            <span class="fs-4 fw-bold ${deu>0.1?'text-danger':'text-success'}">S/ ${deu.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="mt-auto d-grid gap-2">
                        ${!isH && deu > 0.1 ? `<button class="btn btn-success fw-bold py-2 shadow-sm" onclick="window.funcs.pay(${safeId},${deu.toFixed(2)})"><i class="fas fa-money-bill-wave me-2"></i>COBRAR</button>` : ''}
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary" onclick="window.funcs.printTicket(${safeId},${isH})"><i class="fas fa-print"></i> Ticket</button>
                            ${!isH ? `<button class="btn btn-outline-success" onclick="window.funcs.enviarWhatsapp(${safeId})"><i class="fab fa-whatsapp"></i></button>` : ''}
                        </div>
                        ${!isH ? `<button class="btn btn-dark fw-bold py-3 text-uppercase shadow" onclick="window.funcs.checkOut(${safeId},${deu.toFixed(2)})">CHECKOUT <i class="fas fa-sign-out-alt ms-1"></i></button>` : ''}
                    </div>
                </div>
            </div>`;
            document.getElementById('mb').innerHTML = html;
            modalInstance.show();
        },

        setEstadoLimpieza: (num, estado) => { limpieza[num] = estado; saveActiveData(); funcs.registrarLog("LIMPIEZA", `Hab ${num} a ${estado}`); },
        
        abrirModalNuevaReserva: (habPreseleccionada = null) => {
            if(!modalNuevoIngreso) modalNuevoIngreso = new bootstrap.Modal(document.getElementById('modalNuevoIngreso'));
            document.getElementById('cliente').value = ''; document.getElementById('dni').value = ''; document.getElementById('numPersonas').value = '1'; document.getElementById('c_celular').value = ''; document.getElementById('total').value = '0'; document.getElementById('adelanto').value = '0';
            document.getElementById('checkin').value = hoy; document.getElementById('checkout').value = hoy;
            funcs.toggleAdelanto(); 
            funcs.cargarHabitacionesDisponibles(habPreseleccionada);
            modalNuevoIngreso.show();
        },
        
        cargarHabitacionesDisponibles: (habPreseleccionada = null) => {
            let fi = document.getElementById('checkin').value;
            let fo = document.getElementById('checkout').value;
            if(fi && fo) {
                const dateIn = new Date(fi); const dateOut = new Date(fo);
                if(dateOut <= dateIn) {
                    const nextDay = new Date(dateIn); nextDay.setDate(dateIn.getDate() + 1);
                    fo = nextDay.toISOString().split('T')[0];
                    document.getElementById('checkout').value = fo;
                    Swal.fire({toast:true, position:'top-end', icon:'info', title:'Fecha de salida ajustada', timer: 1500, showConfirmButton: false});
                }
            }
            const select = document.getElementById('habSelect');
            select.innerHTML = '';
            const sortedHabs = [...habs].sort((a,b) => {
                const wa = (a.piso.includes('Dept') || a.piso.includes('Muelle')) ? 1 : 2; const wb = (b.piso.includes('Dept') || b.piso.includes('Muelle')) ? 1 : 2;
                if(wa !== wb) return wa - wb; return a.num - b.num;
            });
            sortedHabs.filter(h => h.active !== false).forEach(h => {
                const isFree = !ress.some(r => r.habNum == h.num && fi < r.out && fo > r.in);
                if (isFree || (habPreseleccionada && h.num == habPreseleccionada)) {
                    let displayName = '';
                    if (h.num > 400) displayName = 'Muelle'; else if (h.num > 300) displayName = `Depto ${h.num - 300}`; else displayName = `Hab ${h.num}`;
                    select.innerHTML += `<option value="${h.num}">${displayName}</option>`;
                }
            });
            if(habPreseleccionada) select.value = habPreseleccionada;
            funcs.checkTipoHab('mapa');
        },

        cerrarYReservar: (num) => { if(modalInstance) modalInstance.hide(); setTimeout(() => { funcs.abrirModalNuevaReserva(num); }, 200); },
        
        buscarCliente: async (dni) => { if (dni.length < 8) return; let previo = ress.find(x => x.dni === dni); if (previo) { const elCliente = document.getElementById('cliente'); elCliente.value = previo.cliente; document.getElementById('c_celular').value = previo.celular || ''; } },
        
        guardarReserva: async () => { 
            const d=(id)=>document.getElementById(id).value; const t=parseFloat(d('total'))||0; let ad=d('pagoEstado')==='Pagado'?t:(d('pagoEstado')==='Adelanto'?parseFloat(d('adelanto')):0); 
            if(!d('cliente')) return Swal.fire('Faltan Datos', 'Ingrese el nombre del cliente', 'warning'); 
            const selHab = parseInt(d('habSelect')); let tipo = d('tipoHab');
            if(document.getElementById('tipoHab').disabled) { const hObj = habs.find(h=>h.num === selHab); if(hObj) tipo = hObj.tipo; }
            if(limpieza[selHab]==='sucia'||limpieza[selHab]==='limpieza'){ const result = await Swal.fire({title: 'Habitaci贸n No Lista', text: '驴Asignar igual?', icon: 'warning', showCancelButton: true}); if(!result.isConfirmed) return; } 
            if(!funcs.validarDisponibilidad(selHab,d('checkin'),d('checkout'))) return Swal.fire('Ocupado', 'Fechas ocupadas', 'error'); 
            // Generar ID como String para evitar problemas
            const newId = String(Date.now());
            ress.push({id:newId, cliente:d('cliente'),dni:d('dni'),personas:d('numPersonas'),celular:d('c_celular'),habNum:selHab,tipo:tipo,in:d('checkin'),out:d('checkout'),total:t,adelanto:ad,medioPago:d('medioPago'),consumos:[]}); 
            saveActiveData(); funcs.registrarLog("RESERVA",`Hab ${d('habSelect')} - ${d('cliente')}`); 
            if(modalNuevoIngreso) modalNuevoIngreso.hide(); 
            Swal.fire({icon: 'success', title: 'Reserva Creada', timer: 1500, showConfirmButton: false, toast:true, position:'top-end'});
        },
        
        validarDisponibilidad: (h, i, o, excludeId = null) => { return !ress.some(r => { if(excludeId && r.id === excludeId) return false; return r.habNum == h && i < r.out && o > r.in; }); },
        
        // --- CHECKOUT CORREGIDO Y ROBUSTO ---
        checkOut: async (id, d) => {
            // Forzar cierre de modales UI primero
            funcs.cerrarModalForce();

            const deuda = parseFloat(d);
            const searchId = String(id); 

            if (deuda > 0.1) return Swal.fire('Deuda Pendiente', 'Debe cancelar la deuda antes de realizar el Check-Out.', 'warning');

            const result = await Swal.fire({
                title: '驴Confirmar Salida?', text: "La habitaci贸n pasar谩 a estado SUCIA.", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33', confirmButtonText: 'S铆, finalizar'
            });

            if (!result.isConfirmed) return;

            const index = ress.findIndex(x => String(x.id) === searchId);
            if (index === -1) return Swal.fire('Error', 'Reserva no encontrada (Intente recargar)', 'error');

            const r = ress[index];
            const tC = (r.consumos || []).reduce((a, b) => a + (b.precio * b.cantidad), 0);
            
            // Objeto final para historial
            const finalRes = { 
                ...r, 
                totalFinal: r.total + tC, 
                fechaCierre: new Date().toISOString(), 
                closedBy: currentUser ? currentUser.user : 'system' 
            };

            Swal.fire({title: 'Procesando...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});

            try {
                // 1. Guardar en Colecci贸n Historial
                await addDoc(COL_HISTORY, finalRes);

                // 2. Actualizar estado local
                ress.splice(index, 1);
                limpieza[r.habNum] = 'sucia';

                // 3. Guardar estado activo principal
                await saveActiveData();
                
                funcs.registrarLog("CHECK_OUT", `Hab ${r.habNum} - Salida Cliente`);
                
                // Forzar repintado inmediato
                funcs.actualizarPantalla();
                funcs.renderLimpieza();

                Swal.fire({ icon: 'success', title: 'Check-Out Exitoso', timer: 1500, showConfirmButton: false });

            } catch (e) {
                console.error("Error CheckOut:", e);
                Swal.fire('Error en el proceso', 'Verifique su conexi贸n a internet: ' + e.message, 'error');
                // Intentar recargar datos por si hubo desincronizaci贸n
                funcs.initSystem();
            }
        },
        
        cerrarModalForce: () => {
            if (modalInstance) modalInstance.hide();
            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
        },
        
        checkTipoHab: (origin) => {
            const habId = origin === 'mapa' ? 'habSelect' : 'c_habSelect'; const tipoId = origin === 'mapa' ? 'tipoHab' : 'c_tipoHab';
            if(!document.getElementById(habId)) return;
            const selHab = parseInt(document.getElementById(habId).value); const selTipo = document.getElementById(tipoId);
            const habitacion = habs.find(h => h.num === selHab);
            if (habitacion) { if (habitacion.piso === 'Departamentos' || habitacion.piso === 'Zona Muelle') { selTipo.innerHTML = `<option value="${habitacion.tipo}" selected>${habitacion.tipo}</option>`; selTipo.disabled = true; } else { selTipo.disabled = false; selTipo.innerHTML = `<option>Matrimonial</option><option>Doble</option><option>Triple</option><option>Familiar</option>`; } }
        },

        // --- CAJA & OTROS ---
        guardarMovimientoCaja: () => { const t=document.getElementById('cajaTipo').value,d=document.getElementById('cajaDesc').value,m=parseFloat(document.getElementById('cajaMonto').value);if(!d||!m)return;caja.push({id:Date.now(),fecha:new Date().toLocaleString(),tipo:t,cat:document.getElementById('cajaCat').value,desc:d,monto:m});saveActiveData();funcs.renderCaja();document.getElementById('cajaDesc').value='';document.getElementById('cajaMonto').value='';Swal.fire({icon:'success',title:'Registrado',toast:true,position:'bottom-end',timer:1500}); },
        renderCaja: () => { const t=document.getElementById('bodyCaja');t.innerHTML='';let s=0;[...caja].reverse().forEach(m=>{if(m.tipo==='ingreso')s+=m.monto;else s-=m.monto;t.innerHTML+=`<tr><td class="ps-4">${m.fecha.split(',')[0]}</td><td><span class="badge ${m.tipo==='ingreso'?'bg-success':'bg-danger'}">${m.tipo.toUpperCase()}</span></td><td>${m.cat}</td><td>${m.desc}</td><td class="fw-bold">S/ ${m.monto.toFixed(2)}</td><td><button class="btn btn-sm text-danger" onclick="window.funcs.delCaja(${m.id})"><i class="fas fa-trash"></i></button></td></tr>`;});document.getElementById('cajaSaldo').innerText=`S/ ${s.toFixed(2)}`; },
        delCaja: async (id) => { if(funcs.verificarPermisoAdmin()){const r=await Swal.fire({title:'驴Borrar?',icon:'warning',showCancelButton:true}); if(r.isConfirmed){caja=caja.filter(x=>x.id!==id);saveActiveData();funcs.renderCaja();}} },
        
        // --- EXPORTAR & HELPERS ---
        exportarCalImg: () => { html2canvas(document.getElementById('calContainer')).then(canvas => { const link=document.createElement('a'); link.download=`Calendario_${hoy}.png`; link.href=canvas.toDataURL(); link.click(); }); },
        exportarCalPDF: () => { html2canvas(document.getElementById('calContainer')).then(canvas => { const imgData=canvas.toDataURL('image/png'); const pdf=new jsPDF('landscape'); const imgProps=pdf.getImageProperties(imgData); const pdfWidth=pdf.internal.pageSize.getWidth(); const pdfHeight=(imgProps.height*pdfWidth)/imgProps.width; pdf.addImage(imgData,'PNG',0,0,pdfWidth,pdfHeight); pdf.save(`Calendario_${hoy}.pdf`); }); },
        
        renderCal: () => {
            const t = document.getElementById('tablaCal'); t.innerHTML = '';
            const y = calDate.getFullYear(), m = calDate.getMonth(), days = new Date(y, m + 1, 0).getDate();
            document.getElementById('calMesTitulo').innerText = `${["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"][m]} ${y}`;
            let head = '<thead><tr><th class="cal-room-col">HAB</th>';
            const ds = []; for(let i=1;i<=days;i++){ const iso=`${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`; ds.push(iso); head+=`<th class="${iso===hoy?'cal-today-col':''}">${i}</th>`; } head+='</tr></thead><tbody>';
            const getColor = (r) => { if(r.out === hoy) return 'var(--salida)'; return 'var(--ocupado)'; };
            const sortedHabs = [...habs].sort((a,b) => {
                const wa = (a.piso.includes('Dept') || a.piso.includes('Muelle')) ? 1 : 2; const wb = (b.piso.includes('Dept') || b.piso.includes('Muelle')) ? 1 : 2;
                if(wa !== wb) return wa - wb; return a.num - b.num;
            });
            sortedHabs.filter(h => h.active !== false).forEach(h => {
                const name = h.num > 400 ? 'Muelle' : (h.num > 300 ? `Depto ${h.num-300}` : `Hab ${h.num}`);
                head+=`<tr><td class="cal-room-col">${name}</td>`;
                ds.forEach(d => {
                    const activeRes = ress.find(x => x.habNum == h.num && d >= x.in && d <= x.out);
                    let bg = 'white'; let clickId = null;
                    if(activeRes) {
                         bg = getColor(activeRes);
                         if (activeRes.in === d && activeRes.out !== d) bg = `linear-gradient(to right, white 50%, ${bg} 50%)`; else if (activeRes.out === d && activeRes.in !== d) bg = `linear-gradient(to right, ${bg} 50%, white 50%)`;
                         clickId = `'${activeRes.id}'`; // IDs como string
                    }
                    head+=`<td class="cal-cell" style="background:${bg}" onclick="window.funcs.verDetalle(${h.num},${clickId})"></td>`;
                }); head+='</tr>';
            }); t.innerHTML=head+'</tbody>';
        },
        
        // --- RESTO ---
        agregarProducto: () => { const t=document.getElementById('invTipo').value,n=document.getElementById('invNombre').value,p=parseFloat(document.getElementById('invPrecio').value),s=t==='servicio'?999:parseInt(document.getElementById('invStock').value);if(!n)return;inventario.push({id:Date.now(),nombre:n,precio:p,stock:s,tipo:t});saveActiveData();funcs.renderInventario();document.getElementById('invNombre').value=''; },
        renderInventario: () => { const t=document.getElementById('tablaInventario');t.innerHTML='';inventario.forEach(p=>{t.innerHTML+=`<tr><td class="ps-4 fw-bold text-primary">${p.nombre}</td><td>${p.tipo}</td><td>S/ ${p.precio}</td><td>${p.tipo==='servicio'?'':p.stock}</td><td><button class="btn btn-sm btn-light text-danger" onclick="window.funcs.delInv(${p.id})"><i class="fas fa-trash"></i></button></td></tr>`;}); },
        delInv: async (id) => { if(funcs.verificarPermisoAdmin()){inventario=inventario.filter(x=>x.id!==id);saveActiveData();funcs.renderInventario();} },
        actualizarOperaciones: () => { const f=document.getElementById('fechaOp').value,i=document.getElementById('listIn'),o=document.getElementById('listOut');i.innerHTML='';o.innerHTML='';ress.forEach(r=>{let h=`<div class="op-card ${r.in===f?'op-in':'op-out'}"><div><span class="badge bg-dark me-2">${r.habNum}</span><span class="fw-bold">${r.cliente}</span></div></div>`;if(r.in===f)i.innerHTML+=h;if(r.out===f)o.innerHTML+=h;}); },
        renderLimpieza: () => { 
            const ls=document.getElementById('listSucias'), ll=document.getElementById('listLimpias'); ls.innerHTML=''; ll.innerHTML='';
            habs.forEach(h => {
                const st = limpieza[h.num] || 'limpia';
                const name = h.num > 400 ? 'Muelle' : (h.num > 300 ? `Depto ${h.num-300}` : `Hab ${h.num}`);
                if(st === 'sucia' || st === 'limpieza') {
                    ls.innerHTML += `<div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm border-start border-4 border-warning"><span class="fw-bold fs-5">${name}</span><button class="btn btn-sm btn-primary rounded-pill" onclick="window.funcs.verDetalle(${h.num})">${st==='limpieza'?'Terminar':'Empezar'}</button></div>`;
                } else if(st === 'limpia') {
                    ll.innerHTML += `<div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm border-start border-4 border-success"><span class="fw-bold fs-5 text-muted">${name}</span><i class="fas fa-check-circle text-success"></i></div>`;
                }
            });
        },
        toggleAdelanto: () => { document.getElementById('divAdelanto').style.display=document.getElementById('pagoEstado').value==='Adelanto'?'block':'none'; },
        toggleStockInput: () => { document.getElementById('divStockInput').style.display=document.getElementById('invTipo').value==='servicio'?'none':'block'; },
        
        populateLogUsers: () => { const sel = document.getElementById('filterLogUser'); sel.innerHTML = '<option value="">Todos</option>'; users.forEach(u => sel.innerHTML += `<option value="${u.user}">${u.user}</option>`); },
        registrarLog: async (accion, detalle) => { try { await addDoc(COL_LOGS, { dateIso: new Date().toISOString(), dateStr: new Date().toLocaleString(), user: currentUser ? currentUser.user : 'system', action: accion, details: detalle }); } catch(e) {} },
        renderLogs: async () => { const t=document.getElementById('tablaLogs'); t.innerHTML='<tr><td colspan="4" class="text-center">Cargando...</td></tr>'; const q = query(COL_LOGS, orderBy("dateIso", "desc"), limit(50)); const qs = await getDocs(q); t.innerHTML = ''; qs.forEach((doc) => { const l=doc.data(); t.innerHTML += `<tr><td>${l.dateStr}</td><td>${l.user}</td><td>${l.action}</td><td>${l.details}</td></tr>`; }); },
        renderConfigHabs: () => { const t=document.getElementById('bodyConfigHabs');t.innerHTML=''; habs.sort((a,b)=>a.num-b.num).forEach(h=>{t.innerHTML+=`<tr><td>${h.num}</td><td>${h.piso}</td><td>${h.active!==false?'<span class="badge bg-success">Activa</span>':'<span class="badge bg-secondary">Inactiva</span>'}</td><td><button class="btn btn-sm btn-outline-dark" onclick="window.funcs.toggleHabEstado(${h.num})">Switch</button></td></tr>`;}); },
        agregarHabitacion: () => { const n=parseInt(document.getElementById('confNum').value),p=document.getElementById('confPiso').value;if(n&&p){habs.push({num:n,piso:p,active:true});saveActiveData();funcs.renderConfigHabs();} },
        toggleHabEstado: (n) => { const h = habs.find(x => x.num === n); if(h) { h.active = !h.active; saveActiveData(); funcs.renderConfigHabs(); } },
        checkPermiso: (modId) => { if(currentUser.modules.includes('all')) return true; return currentUser.modules.includes(modId); },
        verificarPermisoAdmin: () => { if (currentUser.modules.includes('all')) return true; Swal.fire('Acceso Denegado', 'Permisos insuficientes', 'error'); return false; },
        addCons: (id) => { const pid = parseInt(document.getElementById('selP').value); const q = parseInt(document.getElementById('selQ').value); const p = inventario.find(i => i.id === pid); if(!p) return; if(p.tipo === 'producto') { if(p.stock < q) return Swal.fire('Sin Stock', `Quedan ${p.stock}`, 'error'); p.stock -= q; } const r = ress.find(x => String(x.id) == String(id)); if(!r.consumos) r.consumos = []; r.consumos.push({ idProd: p.id, item: p.nombre, precio: p.precio, cantidad: q, tipo: p.tipo }); saveActiveData(); funcs.verDetalle(r.habNum, id); },
        delCons: (id, i) => { const r = ress.find(x => String(x.id) == String(id)); const it = r.consumos[i]; if(it.idProd && it.tipo === 'producto') { const p = inventario.find(x => x.id === it.idProd); if(p) { p.stock += it.cantidad; } } r.consumos.splice(i, 1); saveActiveData(); funcs.verDetalle(r.habNum, id); },
        pay: async (id,m) => { const result = await Swal.fire({title: 'Cobrar Saldo', text: `驴Cobrar S/ ${m.toFixed(2)}?`, icon: 'info', showCancelButton: true}); if(result.isConfirmed){const r=ress.find(x=>String(x.id)==String(id));r.adelanto+=m;saveActiveData();funcs.verDetalle(r.habNum,id);funcs.renderCal();} },
        printTicket: (id, isH) => { const r = isH ? historialCache.find(x => String(x.id) == String(id)) : ress.find(x => String(x.id) == String(id)); const ventana = window.open('', 'PRINT', 'height=600,width=400'); ventana.document.write(`<html><body style="font-family:monospace;width:80mm;font-size:12px;text-align:center;"><h3>SUMAJ LODGE</h3><p>RUC: 20XXXXXXXXX<br>Sauce - San Mart铆n</p><hr>HAB: ${r.habNum}<br>Cliente: ${r.cliente}<br>Total: S/${r.total}<hr><p>隆Gracias por su visita!</p></body></html>`); ventana.document.close(); ventana.focus(); setTimeout(() => { ventana.print(); ventana.close(); }, 500); },
        enviarWhatsapp: (id) => { const r = ress.find(x => String(x.id) == String(id)); if(!r || !r.celular) return Swal.fire('Error', 'No hay celular registrado', 'warning'); let phone = r.celular.replace(/\D/g, ''); if(phone.length === 9) phone = '51' + phone; const texto = `Hola ${r.cliente}, gracias por visitar Sumaj Lagoon Lodge. Su cuenta total fue de S/ ${r.total.toFixed(2)}. 隆Esperamos verlo pronto!`; window.open(`https://wa.me/${phone}?text=${encodeURIComponent(texto)}`, '_blank'); },
        editarReserva: (id) => { const r = ress.find(x => String(x.id) == String(id)); if(!r) return; const htmlForm = `<div class="p-4"><h5 class="fw-bold text-primary mb-3">Editar Reserva</h5><input id="edit_cliente" class="form-control mb-2" value="${r.cliente}"><input id="edit_dni" class="form-control mb-2" value="${r.dni||''}"><div class="row g-2 mb-2"><div class="col-6"><input type="date" id="edit_in" class="form-control" value="${r.in}"></div><div class="col-6"><input type="date" id="edit_out" class="form-control" value="${r.out}"></div></div><input type="number" id="edit_total" class="form-control mb-3" value="${r.total}"><button class="btn btn-primary w-100" onclick="window.funcs.guardarEdicion('${r.id}')">Guardar Cambios</button><button class="btn btn-link w-100 mt-2" onclick="window.funcs.verDetalle(${r.habNum}, '${r.id}')">Cancelar</button></div>`; document.getElementById('mb').innerHTML = htmlForm; },
        guardarEdicion: (id) => { const r = ress.find(x => String(x.id) == String(id)); if(!r) return; r.cliente=document.getElementById('edit_cliente').value; r.dni=document.getElementById('edit_dni').value; r.in=document.getElementById('edit_in').value; r.out=document.getElementById('edit_out').value; r.total=parseFloat(document.getElementById('edit_total').value); saveActiveData(); funcs.registrarLog("EDITAR", `Reserva ${r.id} modif`); funcs.verDetalle(r.habNum, r.id); },
        guardarUsuario: () => { if(!funcs.verificarPermisoAdmin()) return; const u = document.getElementById('newUserName').value; const p = document.getElementById('newUserPass').value; const idx = parseInt(document.getElementById('editUserIndex').value); if(!u || !p) return Swal.fire('Error', 'Falta datos', 'warning'); const mods = Array.from(document.querySelectorAll('.perm-check:checked')).map(c=>c.value); if(idx === -1) users.push({user:u, pass:p, modules:mods}); else { users[idx].user=u; users[idx].pass=p; users[idx].modules=mods; } saveActiveData(); funcs.renderUsuarios(); funcs.limpiarFormUsuario(); },
        renderUsuarios: () => { const t=document.getElementById('tablaUsuarios'); t.innerHTML=''; users.forEach((u,i)=>{ t.innerHTML+=`<tr><td class="ps-4 fw-bold">${u.user}</td><td>${u.modules.includes('all')?'ADMIN':u.modules.length+' M贸dulos'}</td><td><button class="btn btn-sm btn-info text-white me-1" onclick="window.funcs.editUser(${i})"><i class="fas fa-pen"></i></button>${u.user!=='admin'?`<button class="btn btn-sm btn-danger" onclick="window.funcs.delUser('${u.user}')"><i class="fas fa-trash"></i></button>`:''}</td></tr>`; }); },
        editUser: (i) => { const u=users[i]; document.getElementById('editUserIndex').value=i; document.getElementById('newUserName').value=u.user; document.getElementById('newUserPass').value=u.pass; document.querySelectorAll('.perm-check').forEach(c => c.checked = u.modules.includes('all') || u.modules.includes(c.value)); },
        delUser: async (u) => { if(funcs.verificarPermisoAdmin()){const r=await Swal.fire({title:'驴Eliminar?',icon:'warning',showCancelButton:true}); if(r.isConfirmed){users=users.filter(x=>x.user!==u);saveActiveData();funcs.renderUsuarios();}} },
        limpiarFormUsuario: () => { document.getElementById('newUserName').value=''; document.getElementById('newUserPass').value=''; document.getElementById('editUserIndex').value='-1'; document.querySelectorAll('.perm-check').forEach(c=>c.checked=false); }
    };

    window.funcs = funcs;
    initRealtimeListener();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
